<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REX-RC Realtime Chat</title>
    <!-- Add favicon -->
    <link rel="icon" type="image/png" href="FXISLOGO.png">
    <!-- Add Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Base font variables */
        :root {
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Arial, sans-serif;
        }

        body {
            font-family: var(--font-primary);
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Update font for all text elements */
        h1, h2, h3, h4, h5, h6, p, span, button, input, textarea, label {
            font-family: var(--font-primary);
        }

        .header-title {
            font-family: var(--font-primary);
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .header-subtitle {
            font-family: var(--font-primary);
            font-weight: 400;
        }

        .settings-button {
            font-family: var(--font-primary);
            font-weight: 500;
        }

        .settings-button span {
            font-family: var(--font-primary);
            font-weight: 500;
        }

        .tab-button {
            font-family: var(--font-primary);
            font-weight: 500;
        }

        .doc-type-button {
            font-family: var(--font-primary);
            font-weight: 500;
        }

        .document-title {
            font-family: var(--font-primary);
            font-weight: 600;
        }

        .settings-modal h3 {
            font-family: var(--font-primary);
            font-weight: 600;
        }

        .settings-modal .slider-container label {
            font-family: var(--font-primary);
            font-weight: 500;
        }

        #startButton, #stopButton {
            font-family: var(--font-primary);
            font-weight: 500;
        }

        .connection-status {
            font-family: var(--font-primary);
            font-weight: 400;
        }

        .transcription-header h2 {
            font-family: var(--font-primary);
            font-weight: 600;
        }

        .chat-input {
            font-family: var(--font-primary);
            font-weight: 400;
        }

        .send-button {
            font-family: var(--font-primary);
            font-weight: 500;
        }

        .message {
            font-family: var(--font-primary);
            font-weight: 400;
        }

        .footer {
            background: linear-gradient(to right, #312e81, #4338ca);
            color: white;
            padding: 0.2rem;  /* Reduced from 0.4rem */
            text-align: center;
            font-size: 0.85rem;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            box-shadow: 0 -1px 3px rgba(0,0,0,0.1);
            z-index: 1000;
            line-height: 1;  /* Reduced from 1.2 */
            height: auto;
            min-height: 24px;  /* Reduced from 30px */
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 2px;  /* Reduced from 4px */
        }

        .footer .name-designation {
            display: inline;
        }

        .footer .links {
            display: inline;
        }

        @media screen and (max-width: 768px) {
            .footer {
                padding: 4px 2px;  /* Reduced from 8px 4px */
                flex-direction: column;
                height: auto;
                gap: 2px;  /* Reduced from 6px */
            }

            .footer .name-designation {
                display: block;
                width: 100%;
            }

            .footer .links {
                display: block;
                width: 100%;
            }
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            padding: 1rem;
            max-width: 1800px;
            margin: 80px auto 40px;  /* Increased top margin */
            height: calc(100vh - 120px);  /* Adjusted height */
            overflow: hidden;
        }
        .top-controls {
            display: flex;
            flex-direction: row;
            gap: 20px;
            margin: 0;
            width: 100%;
            background: none;
            align-items: flex-start;
        }
        .controls-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        .top-controls > div:first-child {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            margin-bottom: -14px;  /* Increased negative margin to reduce space below */
        }
        .content-container {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 0;
            width: 100%;
            box-sizing: border-box;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
            background-color: white;
            padding: 4px 12px;  /* Changed from 4px 12px 2px to make it even */
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            margin: 0;
            position: relative;
            z-index: 2;
        }
        #startButton, #stopButton {
            height: 36px;
            white-space: nowrap;
            padding: 0 16px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #startButton {
            background: #166534;  /* Changed from #4338ca to a darker green */
            color: white;
        }

        #startButton:hover:not(:disabled) {
            background: #14532d;  /* Darker shade for hover */
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        #stopButton {
            background: #9ca3af;  /* Default disabled state */
            color: white;
        }

        #stopButton:not(:disabled) {
            background: #dc2626;  /* Red background when enabled */
        }

        #stopButton:hover:not(:disabled) {
            background: #b91c1c;  /* Darker red on hover */
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        #startButton:disabled, #stopButton:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .value-display {
            min-width: 40px;
            text-align: right;
            font-size: 13px;
        }
        .connection-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 8px;
            font-size: 13px;
            color: #666;
        }

        /* Add connection status icons */
        .connection-status-icon {
            display: none;  /* Hidden by default */
            align-items: center;
            justify-content: center;
            padding: 2px;
        }

        .connection-status-icon img {
            width: 24px;  /* Slightly larger than before */
            height: 24px;
            filter: grayscale(1);  /* Start with grayscale */
            transition: all 0.2s ease;
        }

        .connection-status-icon.connected img {
            filter: none;  /* Show full color when connected */
        }

        .connection-status-icon.disconnected img {
            filter: grayscale(1) brightness(0.9);  /* Slightly darker when disconnected */
        }

        /* Mobile styles */
        @media screen and (max-width: 768px) {
            .connection-indicator {
                margin-left: 4px;
                gap: 4px;
            }

            .connection-status {
                display: none;  /* Hide text on mobile */
            }

            .connection-status-icon {
                display: inline-flex;  /* Show icon on mobile */
            }

            .connection-status-icon img {
                width: 26px;  /* Slightly larger on mobile */
                height: 26px;
            }

            .connection-orb {
                width: 14px;  /* Slightly smaller orb on mobile */
                height: 14px;
            }
        }

        /* Settings button and modal styles */
        .settings-button {
            background: #4338ca;
            border: none;
            cursor: pointer;
            padding: 8px 12px;
            margin-left: 10px;
            color: white;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-family: Arial, sans-serif;
            letter-spacing: normal;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-decoration: none;
        }

        .settings-button span {
            font-size: 13px;
            font-weight: 500;
            line-height: 1;
        }

        .settings-button:hover {
            background: #3730a3;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .settings-button svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
        }

        .settings-modal.active {
            display: block;
        }

        .settings-modal h3 {
            margin: 0 0 20px 0;
            color: #4338ca;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .settings-modal .vad-settings {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .settings-modal .slider-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-modal .slider-container label {
            min-width: 120px;
        }

        .settings-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .settings-modal-overlay.active {
            display: block;
        }

        .settings-modal .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }

        .settings-modal button {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .settings-modal .close-button {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
        }

        .settings-modal .close-button:hover {
            background: #e5e7eb;
        }

        .settings-modal .apply-button {
            background: #4338ca;
            color: white;
            border: none;
        }

        .settings-modal .apply-button:hover {
            background: #3730a3;
        }

        .settings-modal .apply-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .connection-orb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: #ccc;
            position: relative;
        }
        .connection-orb.active {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        .connection-orb.active::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            border: 2.5px solid #28a745;
            animation: ripple 2s infinite;
        }
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
            100% {
                opacity: 1;
            }
        }
        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        #conversation, #transcription-box, #event-log {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-family: monospace;
        }
        .input-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .text-input {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .text-input:focus {
            outline: none;
            border-color: #007bff;
        }
        .send-button {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .send-button:hover:not(:disabled) {
            background: #218838;
        }
        .send-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .message {
            margin: 6px 0px;  /* Increased from 4px to 6px */
            padding: 4px 8px;
            border-radius: 6px;
            font-style: normal;
            font-family: var(--font-primary);
            font-size: 0.925rem;
            line-height: 1.4;
            letter-spacing: -0.01em;
            color: #374151;
            width: 100%;
            box-sizing: border-box;
            overflow-x: auto;
            max-width: none;
        }
        .message.user {
            background: #e3f2fd;
            margin-left: calc(15% + 4px);
            margin-right: 4px;
            width: 85%;
        }
        .message.assistant {
            background: transparent;
            margin-left: 4px;
            margin-right: 4px;
            width: 98%;
        }
        #status {
            color: #666;
            margin-top: 10px;
        }
        .transcription {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            font-style: normal;
            background-color: #ffffff;
            border: 1px solid #e1e4e8;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            font-family: var(--font-primary);
            font-size: 0.925rem;
            line-height: 1.4;
            letter-spacing: -0.01em;
            color: #374151;
        }

        /* Style for metadata (timestamps and tokens) */
        .transcription .metadata {
            font-size: 0.85em;  /* Increased from 0.75em */
            font-style: italic;
            color: #4B5563;  /* Darker gray for better contrast */
            font-weight: 400;
            letter-spacing: 0;
            margin-left: 6px;
            white-space: nowrap;
            display: inline-block;
            opacity: 0.85;  /* Added slight opacity for subtle distinction */
        }

        .transcription.interim {
            color: #6b7280;
            border-left: 3px solid #4338ca;
            background: linear-gradient(to right, #f6f8fa, #ffffff);
            font-weight: 400;
        }

        .transcription.interim .metadata {
            color: #4B5563;  /* Consistent color for all metadata */
        }

        .transcription.final {
            color: #374151;
            border-left: 3px solid #2563eb;
            background: #ffffff;
            font-weight: 400;
        }

        .transcription.final .metadata {
            color: #4B5563;  /* Consistent color for all metadata */
        }
        .transcription:hover {
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #transcription-box {
            background-color: #f8f9fc;
            padding: 12px;  /* Reduced from 20px */
            border: 1px solid #e1e4e8;
            border-radius: 10px;
            font-family: var(--font-primary);
        }
        .token-info {
            color: #6b7280;
            font-size: 0.8em;
            margin-left: 8px;
            opacity: 0.9;
        }
        .transcription-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;  /* Reduced from 8px 12px */
            background: #f0f4ff;
            border-bottom: 1px solid #e5e7eb;
        }
        .transcription-header h2 {
            font-size: 1rem;
            margin: 0;
            color: #4338ca;
            font-weight: 600;
        }
        .transcription-status {
            font-size: 0.875rem;
            color: #6b7280;
        }
        .event-entry {
            padding: 3px 6px;  /* Reduced from 4px 8px */
            margin: 1px 0;  /* Reduced from 2px 0 */
            font-size: 12px;
            display: flex;
            flex-direction: column;
        }
        .event-header {
            display: flex;
            align-items: center;
            gap: 6px;  /* Reduced from 8px */
            cursor: pointer;
            padding: 3px;  /* Reduced from 4px */
            border-radius: 4px;
        }
        .event-header:hover {
            background-color: #f8f9fa;
        }
        .event-arrow {
            font-size: 14px;
            min-width: 20px;
        }
        .event-arrow.up {
            color: #28a745;
        }
        .event-arrow.down {
            color: #007bff;
        }
        .event-time {
            color: #666;
            font-size: 11px;
        }
        .event-type {
            color: #333;
            flex-grow: 1;
        }
        .event-json {
            display: none;
            margin-top: 6px;  /* Reduced from 8px */
            padding: 6px;  /* Reduced from 8px */
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 11px;
            white-space: pre-wrap;
            font-family: monospace;
            color: #333;
            border-left: 3px solid #ddd;
            user-select: text;
            cursor: text;
        }
        .event-entry.expanded .event-json {
            display: block;
        }
        /* Add syntax highlighting colors */
        .json-string { color: #22863a; }
        .json-number { color: #005cc5; }
        .json-boolean { color: #005cc5; }
        .json-null { color: #5a5a5a; }
        .json-key { color: #d73a49; }

        /* Chart container styles */
        .chart-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            height: 350px;
            min-width: 300px;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            transform-origin: center center;
        }
        
        .chart-container.expanded {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            width: 90vw;
            height: 90vh;
            max-width: none;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transform-origin: center center;
        }
        
        .chart-container.expanded .chart-image-container {
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
        }
        
        .chart-container.expanded .chart-image {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .chart-header {
            padding: 8px 12px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f0f4ff;
        }
        
        .chart-header span {
            font-size: 1rem;
            font-weight: 600;
            color: #4338ca;
            margin: 0;
        }
        
        .chart-controls {
            display: flex;
            gap: 8px;
        }
        
        .chart-expand-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #4338ca;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }
        
        .chart-expand-button:hover {
            transform: scale(1.1);
        }
        
        .chart-expand-button svg {
            width: 16px;
            height: 16px;
        }
        
        .chart-content {
            flex: 1;
            position: relative;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            min-height: 0;
            height: calc(100% - 50px);
        }
        
        .chart-image-container {
            position: relative;
            background: white;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            width: 100%;
            height: 100%;
            max-width: 800px;
            max-height: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .chart-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            transition: all 0.3s ease;
        }
        
        .chart-image-container.active {
            display: block;
        }

        /* Navigation arrows */
        .chart-nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            font-size: 20px;
            color: #4b5563;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-nav-button:hover {
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-nav-prev {
            left: 1rem;
        }

        .chart-nav-next {
            right: 1rem;
        }

        /* Chart counter */
        .chart-counter {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            color: #4b5563;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            z-index: 90;
            display: none;
        }

        /* Add default chart state */
        .chart-content-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .chart-image-container {
            position: relative;
            background: white;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
            max-height: 600px;
            aspect-ratio: 4/3;
            display: none;
        }

        /* Add tab system styles */
        .tab-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            height: calc(100vh - 160px);
            min-height: 425px;
            transition: all 0.3s ease;
            position: relative;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .tab-container.expanded {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90vw;
            height: 90vh;
            z-index: 1000;
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .tab-buttons {
            display: flex;
            gap: 1px;
            background: #f0f4ff;
            padding: 2px 8px;
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #e5e7eb;
            justify-content: space-between;
            align-items: center;
        }

        .tab-buttons-left {
            display: flex;
            gap: 1px;
        }

        .tab-expand-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #4338ca;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .tab-expand-button:hover {
            transform: scale(1.1);
        }

        .tab-expand-button svg {
            width: 16px;
            height: 16px;
        }

        .tab-button {
            padding: 0.625rem 1.25rem;
            background: #f0f4ff;  /* Changed from #e5e7eb to match chart header */
            border: 1px solid #d1d5db;
            color: #4338ca;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }

        .tab-button:hover {
            background: #e5eaff;  /* Slightly darker shade for hover */
            border-color: #4338ca;
        }

        .tab-button.active {
            background: #4338ca;
            color: white;
            border: 1px solid #4338ca;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
            flex-direction: column;
            flex: 1;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0 0 8px 8px;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
        }

        /* Add document section styles */
        .document-section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-top: 0;
            overflow: hidden;
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .document-header {
            padding: 10px;
            background-color: #f0f4ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .document-title {
            font-weight: 600;
            color: #4338ca;
        }

        .document-controls {
            display: flex;
            align-items: center;
        }

        .document-type-buttons {
            display: flex;
            gap: 10px;
        }

        .doc-type-button {
            padding: 5px 10px;
            border: none;
            background-color: #f3f4f6;
            color: #6b7280;
            font-weight: 500;
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .doc-type-button.active {
            background-color: #4338ca;
            color: white;
        }

        .control-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            background: #166534;
            color: white;
        }

        .control-button:hover:not(:disabled) {
            background: #14532d;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .control-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .control-button.stop {
            background: #dc2626;
        }

        .control-button.stop:hover:not(:disabled) {
            background: #b91c1c;
        }

        .button-icon {
            width: 20px;
            height: 20px;
        }

        .button-text {
            display: inline;
        }

        .button-text.hidden {
            display: none;
        }

        @media screen and (max-width: 768px) {
            .control-button {
                padding: 8px;
            }
            .button-text {
                display: none;
            }
        }

        .refresh-button {
            color: #4338ca;
        }

        .maximize-button {
            color: #4338ca;
        }

        .collapse-button {
            color: #4338ca;
        }

        .document-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            height: calc(100% - 50px);
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .loading-overlay.hidden {
            display: none;
        }

        #documentFrame {
            width: 100%;
            height: 100%;
            border: none;
            overflow-y: auto;
        }

        /* Add header styles */
        .header {
            background: linear-gradient(135deg, #4338ca 0%, #3730a3 100%);
            color: white;
            padding: 0.5rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            height: auto;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 0;
            padding: 0 20px;
            justify-content: space-between;
            line-height: 0.9;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title {
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0;
            line-height: 1;
        }
        
        .header-divider {
            height: 1rem;
            width: 1px;
            background-color: #6366f1;
            margin: 0 0.25rem;
        }

        .header-subtitle {
            font-size: 0.9rem;
            line-height: 1;
            margin: 0;
        }

        /* Update body margin to account for header */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            overflow-x: hidden;
            width: 100%;
        }

        .main-container {
            max-width: 1400px;
            margin: 45px auto 0;  /* Increased top margin to create space below header */
            padding: 0 20px;
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;  /* Added gap to control vertical spacing */
        }

        /* Update transcription box spacing */
        #transcription-box {
            padding: 12px;
            flex: 1;
            overflow-y: auto;
            max-height: calc(100% - 100px);
        }

        #event-log {
            padding: 12px;
            flex: 1;
            overflow-y: auto;
            max-height: calc(100% - 100px);
        }

        .message {
            margin: 8px 0;
            padding: 10px;
            border-radius: 4px;
            max-width: 80%;
        }

        .message.user {
            background-color: #e3f2fd;
            margin-left: auto;
        }

        .message.assistant {
            background-color: #f5f5f5;
            margin-right: auto;
        }

        .chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: none;
            min-height: 40px;
            max-height: 120px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #007bff;
        }

        /* Add these styles for the text chat tab */
        #text-chat-tab {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        #text-chat-tab.active {
            display: flex;
        }

        #text-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* Tab content styles */
        .tab-content {
            display: none;
            flex-direction: column;
            flex: 1;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0 0 8px 8px;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
        }

        /* Transcription box and event log styles */
        #transcription-box, #event-log, #text-chat-messages {
            flex: 1;
            height: 0;
            min-height: 0;
            overflow-y: auto;
            padding: 12px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            margin: 10px;
            width: calc(100% - 20px); /* Account for margins */
            max-width: 100%;
            box-sizing: border-box;
        }

        .message {
            margin: 8px 0;
            padding: 10px;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            overflow-x: auto;
        }

        .message-content {
            line-height: 1.6;
            color: #2d3748;
            width: 100%;
            overflow-x: auto;
            box-sizing: border-box;
        }

        /* Table specific styles */
        .message-content table {
            border-collapse: collapse;
            margin: 1em 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            min-width: 100%;
            width: max-content;
            max-width: none;
            display: block;
            overflow-x: auto;
        }

        .message-content th,
        .message-content td {
            border: 1px solid #e2e8f0;
            padding: 0.75em;
            text-align: left;
        }

        .message-content th {
            background: #f0f5ff;
            color: #1a365d;
            font-weight: 500;
        }

        .message-content tr:nth-child(even) {
            background: #fafbff;
        }

        .message-content ul,
        .message-content ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }

        .message-content li {
            margin: 0.3em 0;
        }

        .message-content blockquote {
            margin: 0.5em 0;
            padding: 0.5em 1em;
            border-left: 3px solid #4299e1;
            background: #ebf8ff;
            color: #2c5282;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4,
        .message-content h5,
        .message-content h6 {
            color: #2b4c7e;
            margin: 1em 0 0.5em 0;
        }

        .message-content a {
            color: #3182ce;
            text-decoration: none;
        }

        .message-content a:hover {
            text-decoration: underline;
        }

        .message-content pre {
            width: fit-content;  /* Let content determine width */
            min-width: 100%;  /* Ensure it takes at least full width */
            overflow: visible;  /* Remove scroll from pre */
        }

        /* Ensure tab content containers maintain fixed height */
        .tab-content {
            height: 100%;
            display: none;
            flex-direction: column;
            overflow: hidden;  /* Hide overflow at container level */
        }

        .tab-content.active {
            display: flex;
        }

        /* Update transcription container */
        .transcription {
            margin: 8px 0;
            padding: 10px;
            border-radius: 4px;
            width: fit-content;  /* Let content determine width */
        }

        /* Status and input container styles */
        #status {
            flex-shrink: 0;
            padding: 8px 12px;
            margin: 0 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .input-container {
            flex-shrink: 0;
            padding: 10px;
            margin: 0 10px 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border-top: 1px solid #e5e7eb;
        }

        /* Ensure transcription header stays at top */
        .transcription-header {
            flex-shrink: 0;
            padding: 12px;
            background: #f0f4ff;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Add these footer styles to your existing CSS */
        .footer {
            background: linear-gradient(to right, #312e81, #4338ca);
            color: white;
            padding: 0.2rem;  /* Reduced from 0.4rem */
            text-align: center;
            font-size: 0.85rem;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            box-shadow: 0 -1px 3px rgba(0,0,0,0.1);
            z-index: 1000;
            line-height: 1;  /* Reduced from 1.2 */
            height: auto;
            min-height: 24px;  /* Reduced from 30px */
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 2px;  /* Reduced from 4px */
        }

        .footer .name-designation {
            display: inline;
        }

        .footer .links {
            display: inline;
        }

        @media screen and (max-width: 768px) {
            .footer {
                padding: 4px 2px;  /* Reduced from 8px 4px */
                flex-direction: column;
                height: auto;
                gap: 2px;  /* Reduced from 6px */
            }
        }

        .footer a {
            color: white;
            text-decoration: none;
            border-bottom: 1px dotted rgba(255,255,255,0.5);
        }

        .footer a:hover {
            border-bottom: 1px solid white;
        }

        .chart-content-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .placeholder-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            color: #4338ca;
        }

        .placeholder-icon svg {
            opacity: 0.7;
        }

        .placeholder-icon p {
            margin: 0;
            font-size: 1rem;
            color: #4338ca;
            font-weight: 500;
        }

        .chart-content-empty:hover .placeholder-icon {
            color: #4338ca;
            transform: none;
        }

        /* Update placeholder image size */
        .placeholder-icon img {
            width: 400px;
            height: auto;
            opacity: 0.7;
            max-height: 275px;
            object-fit: contain;
        }

        .update-data-button {
            background: #4338ca;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        .update-data-button:hover {
            background: #3730a3;
        }

        /* Mobile-specific styles */
        @media screen and (max-width: 768px) {
            /* Update main container styles */
            .main-container {
                grid-template-columns: 1fr;
                height: calc(100vh - 30px);
                padding: 0.3rem;
                margin-top: 50px;
                display: flex;
                flex-direction: column;
            }

            .mobile-tabs {
                display: flex !important;
                gap: 8px;
                padding: 8px;
                background: white;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                order: 4;  /* Move tabs after VAD visualization */
                margin-bottom: 8px;  /* Add space before content */
            }

            .top-controls {
                margin-top: 0;
                padding-top: 0;
                gap: 5px;
                order: 1;  /* Place controls first */
            }

            .connection-status-container {
                order: 2;  /* Place status after controls */
                margin: 4px 0;  /* Adjust margins */
                padding-left: 16px;
            }

            .voice-activity {
                order: 3;  /* Place VAD visualization after status */
                margin: 8px auto;  /* Add some space around VAD */
            }

            .content-container {
                order: 5;  /* Place content last */
            }

            /* Ensure proper spacing between elements */
            .controls-wrapper {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            /* Adjust controls container */
            .controls {
                width: 100%;
                justify-content: flex-start;
                padding: 8px 16px;
                margin: 0;
            }

            .tab-container,
            .chart-container,
            .document-section {
                display: none;
                height: calc(100vh - 60px);  /* Significantly reduced from 84px */
            }

            /* Message container styles */
            #text-chat-messages, #transcription-box, #event-log {
                height: calc(100% - 40px);  /* Significantly reduced from 72px */
                overflow-y: auto;
                overflow-x: auto;
                padding: 6px;
                background: #fff;
                border: 1px solid #e5e7eb;
                border-radius: 4px;
                margin: 6px;
                width: calc(100% - 12px);
                max-width: 100%;
                box-sizing: border-box;
            }

            .mobile-tabs {
                position: sticky;
                top: 50px;
                z-index: 999;
                margin: 0.15rem 0;  /* Reduced from 0.25rem */
                padding: 0.3rem;  /* Reduced from 0.4rem */
                border-radius: 8px;
                background: white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }

            .content-container {
                margin-top: 0.25rem;  /* Reduced from 0.5rem */
            }

            .header {
                padding: 0.25rem 0;  /* Reduced from 0.3rem */
            }

            .header-content {
                flex-direction: column;
                gap: 2px;  /* Reduced from 3px */
                padding: 0 10px;
            }

            .header-subtitle {
                font-size: 0.8rem;
                line-height: 1.2;
            }

            .header-title {
                font-size: 1rem;
                line-height: 1.2;
            }
        }

        /* Add mobile tab button styles */
        .mobile-tabs .tab-button {
            flex: 1;
            padding: 0.4rem 1rem;  /* Reduced from 0.625rem */
            height: 32px;  /* Reduced from 36px */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
            background: #f3f4f6;
            color: #4338ca;
            font-weight: 500;
            font-size: 0.9rem;  /* Slightly smaller font */
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .mobile-tabs .tab-button:hover {
            background: #eef2ff;
            transform: translateY(-1px);
        }

        .mobile-tabs .tab-button.active {
            background: #4338ca;
            color: white;
            box-shadow: 0 2px 4px rgba(67, 56, 202, 0.2);
        }

        /* Add icons to tabs */
        .mobile-tabs .tab-button[data-tab="chat"]::before {
            content: "ðŸ’¬";
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .mobile-tabs .tab-button[data-tab="charts"]::before {
            content: "ðŸ“Š";
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .mobile-tabs .tab-button[data-tab="docs"]::before {
            content: "ðŸ“‘";
            font-size: 1.1rem;
            opacity: 0.9;
        }

        @media screen and (max-width: 768px) {
            .mobile-tabs {
                display: flex !important;
                gap: 8px;
                padding: 8px;
                background: white;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }
        }

        /* Update mobile tabs and content styles */
        .mobile-tabs {
            position: sticky;
            top: 0;
            z-index: 10;
            margin-bottom: 0.5rem;
            flex-shrink: 0;
            display: none;  /* Hidden by default */
            background: white;
            padding: 0.5rem;
            border-radius: 12px;
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .mobile-tabs .tab-button {
            flex: 1;
            padding: 0.4rem 1rem;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
            background: #f3f4f6;
            color: #4338ca;  /* Indigo color for non-active state */
            font-weight: 500;
            font-size: 0.95rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .mobile-tabs .tab-button:hover {
            background: #eef2ff;
            transform: translateY(-1px);
        }

        .mobile-tabs .tab-button.active {
            background: #4338ca;
            color: white;
            box-shadow: 0 2px 4px rgba(67, 56, 202, 0.2);
        }

        /* Add icons to tabs */
        .mobile-tabs .tab-button[data-tab="chat"]::before {
            content: "ðŸ’¬";
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .mobile-tabs .tab-button[data-tab="charts"]::before {
            content: "ðŸ“Š";
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .mobile-tabs .tab-button[data-tab="docs"]::before {
            content: "ðŸ“‘";
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .mobile-tabs .tab-button:hover {
            background: #f0f1f5;
        }

        .mobile-tabs .tab-button.active {
            background: #4338ca;
            color: white;
            box-shadow: 0 2px 4px rgba(67, 56, 202, 0.2);
            transform: translateY(-1px);
        }

        @media screen and (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                height: calc(100vh - 30px);
                padding: 0.3rem;
                margin-top: 50px;
                display: flex;
                flex-direction: column;
            }

            .mobile-tabs {
                display: flex !important;
            }

            .content-container {
                display: none;
            }

            .content-container.active {
                display: flex;
                flex-direction: column;
                flex: 1;
                overflow: hidden;
            }

            .tab-container,
            .chart-container,
            .document-section {
                display: none;
                height: calc(100vh - 60px);  /* Significantly reduced from 84px */
            }

            .tab-container.active,
            .chart-container.active,
            .document-section.active {
                display: flex;
                flex-direction: column;
                flex: 1;
            }

            .top-controls {
                flex-direction: column;
                gap: 10px;
            }

            .vad-settings {
                flex-wrap: wrap;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }
        }

        @media screen and (max-width: 768px) {
            .header {
                padding: 0.25rem 0;  /* Reduced from 0.3rem */
            }

            .header-content {
                flex-direction: column;
                gap: 2px;  /* Reduced from 3px */
                padding: 0 10px;
            }

            .header-subtitle {
                font-size: 0.8rem;
                line-height: 1.2;
            }

            .header-title {
                font-size: 1rem;
                line-height: 1.2;
            }
        }

        /* Update header styles for better mobile responsiveness */
        @media screen and (max-width: 768px) {
            .header {
                position: relative;  /* Changed from fixed */
                padding: 0.25rem 0;
            }

            .header-content {
                flex-direction: column;
                gap: 2px;
                padding: 0 10px;
            }

            .header-subtitle {
                font-size: 0.8rem;
                line-height: 1.3;
                text-align: center;
            }

            .header-title {
                font-size: 1rem;
                line-height: 1.3;
                text-align: center;
            }

            /* Update main container to use flex layout */
            .main-container {
                display: flex;
                flex-direction: column;
                margin-top: 0;  /* Remove margin since header is not fixed */
                padding: 0.3rem;
                min-height: calc(100vh - 30px);  /* Account for footer */
            }

            /* Update mobile tabs positioning */
            .mobile-tabs {
                position: relative;  /* Changed from sticky */
                top: auto;
                z-index: 2;
                margin: 0.15rem 0;
                padding: 0.3rem;
                background: white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                display: flex !important;
            }

            /* Ensure content stays below tabs */
            .content-container {
                margin-top: 0.15rem;
            }

            .content-container.active {
                display: flex;
                flex-direction: column;
            }

            /* Update top controls spacing */
            .top-controls {
                margin-top: 0.15rem;
            }

            /* Ensure proper spacing for all content */
            .tab-container,
            .chart-container,
            .document-section {
                height: calc(100vh - 60px);  /* Adjust based on header and tabs height */
            }
        }

        /* Add mobile text handling */
        .mobile-text {
            display: none;
        }
        
        @media screen and (max-width: 768px) {
            .mobile-text {
                display: inline;
            }
            .desktop-text {
                display: none;
            }
        }

        /* Settings button and modal styles with gradients */
        .settings-button {
            background: linear-gradient(135deg, #4338ca 0%, #3730a3 100%);
            border: none;
            cursor: pointer;
            padding: 8px 12px;
            margin-left: 10px;
            color: white;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-family: Arial, sans-serif;
            letter-spacing: normal;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-decoration: none;
        }

        .settings-button:hover {
            background: linear-gradient(135deg, #3730a3 0%, #312e81 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        /* Start button with gradient */
        #startButton {
            background: linear-gradient(135deg, #166534 0%, #14532d 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        #startButton:hover:not(:disabled) {
            background: linear-gradient(135deg, #14532d 0%, #052e16 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        /* Document header with gradient */
        .document-header {
            padding: 10px;
            background: linear-gradient(135deg, #f0f4ff 0%, #e5eaff 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Document type buttons with gradient */
        .doc-type-button {
            padding: 5px 10px;
            border: none;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #6b7280;
            font-weight: 500;
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .doc-type-button.active {
            background: linear-gradient(135deg, #4338ca 0%, #3730a3 100%);
            color: white;
        }

        .doc-type-button:hover:not(.active) {
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
        }

        /* Chart header with gradient */
        .chart-header {
            padding: 8px 12px;
            background: linear-gradient(135deg, #f0f4ff 0%, #e5eaff 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Tab buttons with gradient */
        .tab-button {
            padding: 0.625rem 1.25rem;
            background: linear-gradient(135deg, #f0f4ff 0%, #e5eaff 100%);
            border: 1px solid #d1d5db;
            color: #4338ca;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }

        .tab-button:hover {
            background: linear-gradient(135deg, #e5eaff 0%, #dae3ff 100%);
            border-color: #4338ca;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #4338ca 0%, #3730a3 100%);
            color: white;
            border: 1px solid #4338ca;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Message container styles */
        #text-chat-messages, #transcription-box, #event-log {
            height: calc(100% - 40px);  /* Significantly reduced from 72px */
            overflow-y: auto;
            overflow-x: auto;
            padding: 6px;  /* Reduced from 8px */
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            margin: 6px;  /* Reduced from 8px */
            width: calc(100% - 12px);  /* Adjusted for new margins */
            max-width: 100%;
            box-sizing: border-box;
        }

        .message {
            margin: 1px 0;
            padding: 4px 8px;
            border-radius: 6px;
            font-style: normal;
            font-family: var(--font-primary);
            font-size: 0.925rem;
            line-height: 1.4;
            letter-spacing: -0.01em;
            color: #374151;
            width: 100%;  /* Base width for messages */
            box-sizing: border-box;
            overflow-x: auto;
            max-width: none;
        }

        .message.user {
            background: #e3f2fd;
            margin-left: calc(15% + 4px);  /* Push user messages to start ~1 inch from left */
            margin-right: 4px;
            width: 85%;  /* Make user messages slightly narrower */
        }

        .message.assistant {
            background: transparent;  /* Remove background */
            margin-left: 4px;
            margin-right: 4px;  /* Add right margin to match user messages */
            width: 98%;  /* Keep assistant messages wide */
        }

        .message-content {
            line-height: 1.3;
            color: #374151;
            font-family: var(--font-primary);
            font-size: 0.925rem;
            letter-spacing: -0.01em;
            width: 100%;  /* Ensure content uses full width */
            overflow-x: auto;
            box-sizing: border-box;
            padding: 0;
            max-width: none;  /* Remove any max-width constraints */
        }

        /* Message container styles */
        #text-chat-messages, #transcription-box, #event-log {
            height: calc(100% - 40px);  /* Significantly reduced from 72px */
            overflow-y: auto;
            overflow-x: auto;
            padding: 6px;  /* Reduced from 8px */
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            margin: 6px;  /* Reduced from 8px */
            width: calc(100% - 12px);  /* Adjusted for new margins */
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Reduce spacing in markdown content */
        .message-content p {
            margin: 0 0 0.2em 0;  /* Reduced from 0.3em */
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        /* Table specific styles - make more compact */
        .message-content table {
            margin: 0.2em 0;  /* Reduced from 0.3em */
            border-collapse: collapse;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            font-size: 0.9em;
            min-width: 100%;
            width: max-content;
            max-width: none;
            display: block;
            overflow-x: auto;
            border: 1px solid #e2e8f0;
        }

        .message-content th,
        .message-content td {
            border: 1px solid #e2e8f0;
            padding: 0.4em 0.6em;  /* Reduced from 0.75em */
            text-align: left;
            line-height: 1.3;  /* Added to reduce row height */
        }

        .message-content th {
            background: #f0f5ff;
            color: #1a365d;
            font-weight: 500;
            white-space: nowrap;  /* Keep headers on one line */
        }

        .message-content tr:nth-child(even) {
            background: #fafbff;
        }

        /* Adjust list spacing */
        .message-content ul,
        .message-content ol {
            margin: 0.3em 0;  /* Reduced from 0.5em */
            padding-left: 1.2em;  /* Reduced from 1.5em */
        }

        .message-content li {
            margin: 0.2em 0;  /* Reduced from 0.3em */
        }

        /* Adjust blockquote spacing */
        .message-content blockquote {
            margin: 0.3em 0;  /* Reduced from 0.5em */
            padding: 0.3em 0.8em;  /* Reduced from 0.5em 1em */
            border-left: 3px solid #4299e1;
            background: #ebf8ff;
            color: #2c5282;
        }

        /* Adjust heading spacing */
        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4,
        .message-content h5,
        .message-content h6 {
            color: #2b4c7e;
            margin: 0.8em 0 0.3em 0;  /* Reduced bottom margin */
            line-height: 1.3;
        }

        /* Sample Data Table Styles */
        .sample-data-section {
            margin: 2rem auto;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: none;
            width: 98%;
            margin-bottom: 60px; /* Add space for footer */
        }

        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            width: 100%;
            white-space: nowrap;  /* Prevent text wrapping */
        }

        .sample-data-table {
            width: 100%;
            table-layout: fixed;  /* Use fixed layout for better column control */
            border-collapse: collapse;
            font-size: 0.75rem;  /* Slightly smaller font */
            font-family: var(--font-primary);
            white-space: nowrap;  /* Prevent text wrapping */
        }

        .sample-data-table thead {
            background: linear-gradient(135deg, #f0f4ff 0%, #e5eaff 100%);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .sample-data-table th {
            padding: 0.5rem;  /* Reduced padding */
            text-align: left;
            font-weight: 600;
            color: #4338ca;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: inherit;  /* Keep gradient visible */
        }

        .sample-data-table td {
            padding: 0.4rem 0.5rem;  /* Reduced padding */
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Set specific widths for columns */
        .sample-data-table th:nth-child(1),  /* Match ID */
        .sample-data-table td:nth-child(1) {
            width: 80px;
        }
        
        .sample-data-table th:nth-child(2),  /* Season */
        .sample-data-table td:nth-child(2) {
            width: 70px;
        }
        
        .sample-data-table th:nth-child(3),  /* Start Date */
        .sample-data-table td:nth-child(3) {
            width: 90px;
        }
        
        .sample-data-table th:nth-child(4),  /* Venue */
        .sample-data-table td:nth-child(4) {
            width: 200px;
        }
        
        .sample-data-table th:nth-child(5),  /* Innings */
        .sample-data-table td:nth-child(5) {
            width: 60px;
        }
        
        .sample-data-table th:nth-child(6),  /* Ball */
        .sample-data-table td:nth-child(6) {
            width: 60px;
        }
        
        .sample-data-table th:nth-child(7),  /* Batting Team */
        .sample-data-table th:nth-child(8),  /* Bowling Team */
        .sample-data-table td:nth-child(7),
        .sample-data-table td:nth-child(8) {
            width: 100px;
        }
        
        .sample-data-table th:nth-child(9),  /* Striker */
        .sample-data-table th:nth-child(10), /* Non Striker */
        .sample-data-table th:nth-child(11), /* Bowler */
        .sample-data-table td:nth-child(9),
        .sample-data-table td:nth-child(10),
        .sample-data-table td:nth-child(11) {
            width: 120px;
        }
        
        /* Numeric columns */
        .sample-data-table th:nth-child(n+12):nth-child(-n+18),  /* Runs to Penalty */
        .sample-data-table td:nth-child(n+12):nth-child(-n+18) {
            width: 60px;
            text-align: center;
        }
        
        /* Wicket columns */
        .sample-data-table th:nth-child(n+19),  /* Wicket columns */
        .sample-data-table td:nth-child(n+19) {
            width: 120px;
        }

        .sample-data-table tbody tr:hover {
            background-color: #f8faff;
        }

        .sample-data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Responsive styles for the table */
        @media screen and (max-width: 768px) {
            .sample-data-section {
                margin: 0.5rem;
                padding: 0.25rem;
                width: calc(100% - 1rem);
                margin-bottom: 50px; /* Ensure space for footer on mobile */
            }

            .table-container {
                margin-bottom: 10px; /* Add some space at the bottom */
            }

            body {
                padding-bottom: 50px; /* Add padding to body for footer */
            }

            .footer {
                height: auto; /* Allow footer to adjust height on mobile */
                min-height: 30px; /* Minimum height on mobile */
                padding: 0.3rem;
                font-size: 0.8rem;
            }

            .sample-data-table {
                font-size: 0.7rem;  /* Even smaller font for mobile */
            }

            .sample-data-table th,
            .sample-data-table td {
                padding: 0.3rem;  /* Further reduced padding for mobile */
            }
        }

        /* Update mobile tab container height */
        @media screen and (max-width: 768px) {
            .tab-container {
                height: calc(100vh - 40px) !important;  /* Increase height */
                min-height: 500px !important;  /* Add minimum height */
            }
            
            .chart-container,
            .document-section {
                height: calc(100vh - 40px) !important;  /* Match the tab container height */
                min-height: 500px !important;  /* Match the minimum height */
            }
        }

        /* Add connection status container styles */
        .connection-status-container {
            padding: 0;
            color: #3c1f0d !important;
            font-size: 14px !important;
            background: none;
            margin: -35px 0 -10px 0;  /* Increased negative top margin by 2px more */
            line-height: 0.4;
            height: min-content;
            display: inline-block;
            vertical-align: top;
            transform: translateY(-20px);  /* Increased negative transform by 2px more */
            font-weight: 600;
            position: relative;
            z-index: 1;
            text-align: left;
        }

        @media screen and (max-width: 768px) {
            .connection-status-container {
                font-size: 12px;
                margin: -8px 0 -8px 0;
                transform: translateY(0);
                width: auto;  /* Changed from 100% to auto */
                text-align: left !important;  /* Force left alignment */
                position: relative;
                top: 8px;
                padding-left: 12px;  /* Match controls padding */
                display: inline-block;  /* Ensure inline-block display */
                justify-content: flex-start;  /* Add flex start */
                align-items: flex-start;  /* Add align start */
            }

            .controls {
                justify-content: flex-start !important;  /* Force left alignment */
                padding-left: 12px;
                width: auto;  /* Changed from 100% to auto */
                text-align: left;
            }
        }

        /* Add voice activity visualization styles */
        .voice-activity {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;  /* Increased from 6px */
            padding: 12px 12px 12px 8px;  /* Increased padding */
            margin: 0;
            display: flex;
            flex-direction: row;
            gap: 16px;  /* Increased from 12px */
            width: 300px;
            min-width: auto;
            box-shadow: 0 4px 12px rgba(67, 56, 202, 0.08);  /* Added subtle colored shadow */
            align-items: center;
            transition: all 0.3s ease;  /* Added smooth transition */
        }

        .voice-activity:hover {
            box-shadow: 0 6px 16px rgba(67, 56, 202, 0.12);  /* Enhanced shadow on hover */
            transform: translateY(-1px);  /* Subtle lift effect */
        }

        .voice-activity-row {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 12px;
            flex: 1;
            position: relative;
            width: 100%;  /* Ensure full width */
        }

        .voice-activity-label {
            writing-mode: vertical-lr;
            transform: rotate(180deg);
            text-orientation: mixed;
            width: auto;
            flex-shrink: 0;  /* Prevent label from shrinking */
            font-size: 13px;
            color: #4338ca;
            text-align: center;
            font-weight: 600;
            white-space: nowrap;
            padding: 4px 0;
            position: relative;
            left: -2px;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            font-size: 11px;
        }

        .voice-activity-bars {
            width: 100%;
            height: 44px;
            display: flex;
            gap: 3px;
            align-items: flex-end;
            padding: 0 2px;
            flex: 1;
            min-width: 0;  /* Allow bars container to shrink */
        }

        .voice-activity-bar {
            width: 3px;
            background: #4338ca;
            height: 100%;
            transform-origin: bottom;
            transition: transform 0.15s ease;
            border-radius: 4px;
            opacity: 0.7;
            flex: 1;  /* Allow bars to grow */
            min-width: 3px;  /* Maintain minimum width */
        }

        .voice-activity-bar:hover {
            opacity: 1;  /* Full opacity on hover */
        }

        .voice-activity-bar.assistant {
            background: linear-gradient(180deg, #10b981 0%, #059669 100%);  /* Added gradient */
            opacity: 0.8;
        }

        /* Mobile styles */
        @media screen and (max-width: 768px) {
            .voice-activity {
                width: 90%;
                padding: 8px;  /* Reduced padding */
                margin: 2px auto;
                min-width: 250px;
                background: white;
                border-radius: 10px;
                display: flex;
                flex-direction: row;
                gap: 10px;
                height: 70px;  /* Reduced overall height */
            }
            
            .voice-activity-row {
                flex: 1;
                display: flex;
                flex-direction: column-reverse;
                align-items: center;
                min-width: 0;
                height: 100%;
                gap: 2px;  /* Added small gap between bars and label */
            }
            
            .voice-activity-label {
                writing-mode: horizontal-tb;
                transform: none;
                padding: 0;
                margin-top: 2px;  /* Reduced margin */
                font-size: 12px;
                color: #4338ca;
                text-align: center;
            }
            
            .voice-activity-bars {
                width: 100%;
                height: 32px;  /* Slightly reduced height */
                display: flex;
                gap: 2px;
                align-items: flex-end;
                min-height: 32px;  /* Match height */
            }

            .voice-activity-bar {
                flex: 1;
                min-width: 2px;
                background: #4338ca;
                height: 100%;
                opacity: 0.7;
                transform-origin: bottom;
                transition: transform 0.15s ease;
                border-radius: 4px;
            }

            .voice-activity-bar.assistant {
                background: linear-gradient(180deg, #10b981 0%, #059669 100%);
            }
        }

        /* Remove any conflicting mobile styles from other media queries */
        @media screen and (max-width: 768px) {
            .voice-activity {
                width: 90%;
                margin: 2px auto;
                min-width: 250px;
                background: white;
            }
        }

        /* Add animation for bars */
        @keyframes barPulse {
            0% { opacity: 0.7; }
            50% { opacity: 0.9; }
            100% { opacity: 0.7; }
        }

        .voice-activity-bar.active {
            animation: barPulse 1.5s ease-in-out infinite;
        }

        @media screen and (max-width: 768px) {
            .top-controls {
                margin-top: 0;
                padding-top: 0;
                gap: 5px;
            }

            .top-controls > div:first-child {
                flex-direction: column;
                gap: 10px;
            }

            .controls {
                width: 100%;
                justify-content: flex-start;
                padding-left: 16px;
            }

            .voice-activity {
                width: 100%;
                margin: 0 auto;
                min-width: 250px;
                background: white;  /* Ensure white background on mobile too */
            }
        }

        @media screen and (max-width: 768px) {
            .top-controls {
                margin-top: 0;
                padding-top: 0;
                gap: 0;
            }

            .top-controls > div:first-child {
                flex-direction: column;
                gap: 10px;
                margin-bottom: 0;  /* Reset margin for mobile */
            }

            .controls {
                width: 100%;
                justify-content: flex-start;  /* Changed from center to flex-start */
                margin-bottom: -14px;  /* Add negative margin to pull status line up */
            }

            .connection-status-container {
                font-size: 12px;
                padding: 0 12px;
                margin: -20px 0 -8px 0;  /* Keep similar margins as desktop */
                transform: translateY(-6px);  /* Keep similar transform as desktop */
                width: 100%;
                text-align: center;
            }

            .voice-activity {
                width: 100%;
                margin: 10px auto 0;  /* Add top margin to separate from status line */
                min-width: 250px;
                order: 3;  /* Ensure it comes after status line */
            }

            .voice-activity-label {
                font-size: 12px;
            }
            
            .voice-activity-bars {
                height: 32px;
            }
            
            .voice-activity-bar {
                width: 3px;
            }
        }

        @media screen and (max-width: 768px) {
            .tab-content {
                height: calc(100% - 10px);  /* Slightly reduce height to prevent overflow */
                display: none;
                flex-direction: column;
                padding-bottom: 10px;  /* Add padding at bottom */
            }

            .tab-content.active {
                display: flex;
            }

            /* Adjust transcription box height */
            #transcription-box, #event-log, #text-chat-messages {
                height: calc(100% - 80px);  /* Reduced height to make room for input */
                min-height: 200px;  /* Ensure minimum height */
                margin-bottom: 8px;  /* Add space before input container */
            }

            /* Style input container for mobile */
            .input-container {
                position: relative;  /* Ensure it stays at bottom */
                bottom: 0;
                left: 0;
                right: 0;
                padding: 8px;
                background: #f8f9fa;
                border-top: 1px solid #e5e7eb;
                margin: 0 8px 8px 8px;  /* Add margin on all sides */
                border-radius: 4px;
                min-height: 56px;  /* Ensure minimum height for input area */
                display: flex;
                gap: 8px;
                align-items: center;
            }

            /* Adjust text input styling */
            .text-input {
                flex: 1;
                min-height: 40px;  /* Minimum height for input */
                padding: 8px 12px;
                border: 1px solid #e5e7eb;
                border-radius: 4px;
                font-size: 14px;
                line-height: 1.4;
                resize: none;
                margin: 0;
            }

            /* Ensure send button is properly sized */
            .send-button {
                height: 40px;
                padding: 0 16px;
                white-space: nowrap;
                font-size: 14px;
            }

            /* Adjust tab container height */
            .tab-container {
                height: calc(100vh - 180px) !important;  /* Increased height */
                min-height: 400px !important;  /* Ensure minimum height */
                display: flex;
                flex-direction: column;
            }

            /* Ensure content fills available space */
            .tab-content {
                flex: 1;
                display: none;
                flex-direction: column;
                overflow: hidden;
            }

            .tab-content.active {
                display: flex;
            }
        }

        @media screen and (max-width: 768px) {
            /* Container for VAD and tabs combined */
            .vad-and-tabs-container {
                display: flex;
                gap: 8px;
                padding: 4px;
                width: 100%;
                order: 3;
                margin: 8px 0;
            }

            /* Adjust VAD visualization for mobile */
            .voice-activity {
                width: 45%;
                min-width: 150px;
                padding: 4px 6px 4px 2px;
                margin: 0;
                gap: 8px;
            }

            .voice-activity-row {
                flex: 1;
                width: 100%;
                min-width: 0; /* Allow shrinking */
            }

            .voice-activity-bars {
                flex: 1;
                width: 100%;
                min-width: 0; /* Allow shrinking */
                display: flex;
                gap: 2px;
                justify-content: space-between; /* Distribute bars evenly */
            }

            .voice-activity-bar {
                flex: 1; /* Make bars take equal width */
                width: auto; /* Override fixed width */
                min-width: 2px; /* Minimum width for bars */
                max-width: 4px; /* Maximum width for bars */
            }

            .voice-activity-label {
                font-size: 11px;
                padding: 2px 0;
                width: auto;
                flex-shrink: 0; /* Prevent label from shrinking */
            }

            .voice-activity-bars {
                height: 28px;
            }

            /* Adjust mobile tabs for new layout */
            .mobile-tabs {
                display: grid !important;
                grid-template-columns: 1fr 1fr;
                grid-gap: 4px;
                width: 55%;
                padding: 4px;
                margin: 0;
                background: none;
                box-shadow: none;
                order: unset;
            }

            .mobile-tabs .tab-button {
                font-size: 0.8rem;
                padding: 6px 8px;
                height: auto;
                min-height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: white;
                border: 1px solid #e5e7eb;
                box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            }

            /* Special handling for the third button */
            .mobile-tabs .tab-button:last-child {
                grid-column: span 2;
            }

            .mobile-tabs .tab-button::before {
                font-size: 0.9rem;
                margin-right: 4px;
            }

            /* Adjust main container spacing */
            .main-container {
                gap: 4px;
            }

            /* Move the content container up */
            .content-container {
                margin-top: 0;
            }

            /* Wrap VAD and tabs in a new container */
            .controls-wrapper {
                gap: 4px;
            }
        }

        @media screen and (min-width: 769px) {
            /* Desktop-specific styles */
            .vad-and-tabs-container {
                display: inline-flex;
                gap: 8px;
                padding: 0;
                width: auto;
                position: absolute;
                left: 700px;  /* Increased from 600px to move right */
                top: 40px;
                z-index: 1;
            }

            .voice-activity {
                width: 300px;
                min-width: auto;
                margin: 0;
            }

            .mobile-tabs {
                display: none !important;  /* Hide mobile tabs on desktop */
            }
        }

        @media screen and (max-width: 768px) {
            .controls {
                width: 100%;
                justify-content: flex-start;
                padding: 8px 10px;  /* Reduced horizontal padding */
                gap: 4px;  /* Reduced gap between buttons */
            }

            .settings-button {
                margin-left: 4px;  /* Reduced margin */
                padding: 6px 6px;  /* Reduced padding */
            }

            .settings-button svg {
                width: 14px;  /* Slightly smaller icon */
                height: 14px;
            }

            .settings-button .mobile-text {
                margin-left: 2px;  /* Minimal space between icon and text */
                font-size: 0.85rem;  /* Smaller text */
            }
        }

        .chart-controls {
            display: flex;
            gap: 8px;
        }

        .chart-copy-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #4338ca;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .chart-copy-button:hover {
            transform: scale(1.1);
        }

        .chart-copy-button svg {
            width: 16px;
            height: 16px;
        }

        .chart-copy-button.copied {
            color: #059669;
        }
    </style>
    <!-- Add marked library for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Add DOMPurify for sanitization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="header-title">REX-RC Realtime</h1>
                <div class="header-divider"></div>
                <span class="header-subtitle">
                    Realtime Voice (OpenAI). Connected to PostGreSQL Database | ODI Cricket - 2003-2024 -2860 Matches - 1.5M Rows
                </span>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Voice activity visualization and mobile tabs container -->
        <div class="vad-and-tabs-container">
            <div class="voice-activity">
                <div class="voice-activity-row">
                    <div class="voice-activity-label">User</div>
                    <div class="voice-activity-bars" id="userVoiceActivity">
                        <!-- Bars will be added dynamically -->
                    </div>
                </div>
                <div class="voice-activity-row">
                    <div class="voice-activity-label">Agent</div>
                    <div class="voice-activity-bars" id="assistantVoiceActivity">
                        <!-- Bars will be added dynamically -->
                    </div>
                </div>
            </div>

            <!-- Mobile tabs -->
            <div class="mobile-tabs">
                <button class="tab-button active" data-tab="chat">Chat</button>
                <button class="tab-button" data-tab="charts">Charts</button>
                <button class="tab-button" data-tab="docs">Docs</button>
            </div>
        </div>

        <div class="top-controls">
            <div class="controls-wrapper">
                <div class="controls">
                    <button id="startButton" class="control-button">
                        <svg class="button-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 3l14 9-14 9V3z"/>
                        </svg>
                        <span class="button-text">Connect</span>
                    </button>
                    <button id="stopButton" class="control-button stop" disabled>
                        <svg class="button-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="4" y="4" width="16" height="16"/>
                        </svg>
                        <span class="button-text">Stop</span>
                    </button>
                    <div class="connection-indicator">
                        <div class="connection-orb"></div>
                        <span class="connection-status">Disconnected</span>
                        <span class="connection-status-icon disconnected" title="No Signal">
                            <img src="no-mobile-phones-svgrepo-com.svg" alt="No Signal" />
                        </span>
                    </div>
                    <button class="settings-button" id="openSettings">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                        <span class="button-text">VAD</span>
                    </button>
                    <a href="https://rex.tigzig.com/csv-processor" target="_blank" class="settings-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"></path>
                            <path d="M16 5h6"></path>
                            <path d="M21 5v6"></path>
                            <line x1="12" y1="12" x2="21" y2="3"></line>
                        </svg>
                        <span class="desktop-text">Data</span>
                        <span class="mobile-text">Data</span>
                    </a>
                    <a href="https://rex.tigzig.com/analyzer" target="_blank" class="settings-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 3v18h18"></path>
                            <path d="M18 17V9"></path>
                            <path d="M13 17V5"></path>
                            <path d="M8 17v-3"></path>
                        </svg>
                        <span class="desktop-text">Analyze</span>
                        <span class="mobile-text">Analyze</span>
                    </a>
                </div>
                <div id="status" class="connection-status-container">Status: Ready to connect</div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="settings-modal-overlay" id="settingsOverlay"></div>
        <div class="settings-modal" id="settingsModal">
            <h3>Voice Activity Detection Settings</h3>
            <div class="vad-settings">
                <div class="slider-container">
                    <label for="threshold">Threshold:</label>
                    <input type="range" id="threshold" min="0" max="1" step="0.01" value="0.75">
                    <span class="value-display" id="thresholdValue">0.75</span>
                </div>
                <div class="slider-container">
                    <label for="prefixPadding">Prefix Padding:</label>
                    <input type="range" id="prefixPadding" min="0" max="2000" step="100" value="1000">
                    <span class="value-display" id="prefixPaddingValue">1000</span>
                </div>
                <div class="slider-container">
                    <label for="silenceDuration">Silence Duration:</label>
                    <input type="range" id="silenceDuration" min="0" max="2000" step="100" value="1000">
                    <span class="value-display" id="silenceDurationValue">1000</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="close-button" id="closeSettings">Cancel</button>
                <button class="apply-button" id="submitVadSettings" disabled>Apply Changes</button>
            </div>
        </div>

        <div class="content-container">
            <!-- Tab container -->
            <div class="tab-container">
                <div class="tab-buttons">
                    <div class="tab-buttons-left">
                        <button class="tab-button active" data-tab="transcription">
                            <span class="desktop-text">Live Transcription</span>
                            <span class="mobile-text">Live</span>
                        </button>
                        <button class="tab-button" data-tab="event-log">
                            <span class="desktop-text">Event Log</span>
                            <span class="mobile-text">Log</span>
                        </button>
                        <button class="tab-button" data-tab="text-chat">
                            <span class="desktop-text">Text Chat with AI</span>
                            <span class="mobile-text">Text Chat</span>
                        </button>
                    </div>
                    <button class="tab-expand-button" title="Expand/Collapse">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Transcription tab -->
                <div class="tab-content active" id="transcription-tab">
                    <div class="transcription-header">
                        <h2>Live Transcription</h2>
                        <span class="transcription-status" id="transcription-status">Waiting...</span>
                    </div>
                    <div id="transcription-box"></div>
                    <div class="input-container">
                        <input type="text" id="textInput" class="text-input" placeholder="Type a message..." disabled>
                        <button id="sendButton" class="send-button" disabled>Send</button>
                    </div>
                </div>

                <!-- Event log tab -->
                <div class="tab-content" id="event-log-tab">
                    <div class="transcription-header">
                        <h2>Event Log</h2>
                    </div>
                    <div id="event-log"></div>
                </div>

                <!-- Text chat tab -->
                <div class="tab-content" id="text-chat-tab">
                    <div class="transcription-header">
                        <h2>Text Chat with AI</h2>
                    </div>
                    <div class="messages-container" id="text-chat-messages"></div>
                    <div class="input-container">
                        <textarea id="textChatInput" class="chat-input" placeholder="Type your message..." rows="1"></textarea>
                        <button id="textChatSendButton" class="send-button">Send</button>
                    </div>
                </div>
            </div>

            <!-- Chart container -->
            <div class="container">
                <!-- Chart section -->
                <div class="chart-container">
                    <div class="chart-header">
                        <span>Charts</span>
                        <div class="chart-controls">
                            <button class="chart-expand-button" title="Expand/Collapse">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                                </svg>
                            </button>
                            <button class="chart-copy-button" title="Copy Chart">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="chart-content" id="chartContent">
                        <button class="chart-nav-button chart-nav-prev">â†</button>
                        <button class="chart-nav-button chart-nav-next">â†’</button>
                        <div class="chart-counter">0 / 0</div>
                        <div class="chart-content-empty">
                            <div class="placeholder-icon">
                                <img src="/chart_heatmap_dummy.png" alt="Chart placeholder" style="width: 400px; height: auto; opacity: 0.7;">
                                <p>Charts will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document section -->
                <div class="document-section">
                    <div class="document-header">
                        <span class="document-title">Docs</span>
                        <div class="document-controls">
                            <div class="document-type-buttons">
                                <button class="doc-type-button" data-type="excel">Excel</button>
                                <button class="doc-type-button" data-type="google">Google</button>
                                <button class="doc-type-button active" data-type="docs">Docs</button>
                            </div>
                            <button class="control-button refresh-button" title="Refresh">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                            </button>
                            <button class="control-button maximize-button" title="Maximize">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                            </button>
                            <button class="control-button collapse-button" title="Collapse">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                            </button>
                        </div>
                    </div>
                    <div class="document-content">
                        <div class="loading-overlay hidden">
                            <span>Refreshing...</span>
                        </div>
                        <iframe id="documentFrame" frameborder="0" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // All hardcoded configuration constants
        const RT_MODEL = 'gpt-4o-mini-realtime-preview-2024-12-17';
        const RT_VOICE = 'alloy';
        const RT_ENDPOINT = 'https://rtephemeral.hosting.tigzig.com/session';
        const CRICKET_API_ENDPOINT = 'https://flowise-coolify.hosting.tigzig.com/api/v1/prediction/5e61fc5e-a2d9-410d-b1a4-1519fa0c3b4d';
        const SHOW_AUDIO_TRANSCRIPT_DELTA = 0;
        const SHOW_DELTA_EVENTS = 0;

        let pc;
        let dc;
        let audioEl;
        let currentTranscriptionDiv = null;
        let currentResponseId = null;
        let audioContext;
        let userAnalyser;
        let assistantAnalyser;
        let userVoiceActivityBars = [];
        let assistantVoiceActivityBars = [];
        const NUM_BARS = 20;

        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const conversation = document.getElementById('conversation');
        const transcriptionBox = document.getElementById('transcription-box');
        const transcriptionStatus = document.getElementById('transcription-status');
        const status = document.getElementById('status');
        const textInput = document.getElementById('textInput');
        const sendButton = document.getElementById('sendButton');

        // Cricket Database Query Function
        const sessionId = Math.random().toString(36).substring(7);
        async function queryCricketDatabase(data) {
            const response = await fetch(
                CRICKET_API_ENDPOINT,
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Origin": window.location.origin,
                        "Referer": window.location.origin
                    },
                    body: JSON.stringify({
                        question: data.question,
                        overrideConfig: {
                            sessionId: sessionId
                        }
                    })
                }
            );
            const result = await response.json();
            if (!response.ok) {
                console.log('Cricket API Response:', result);
                throw new Error(result.message || 'Failed to query cricket database');
            }
            return result;
        }

        // Initialize voice activity visualization
        function initVoiceActivity() {
            const userBarsContainer = document.getElementById('userVoiceActivity');
            const assistantBarsContainer = document.getElementById('assistantVoiceActivity');

            // Create bars
            for (let i = 0; i < NUM_BARS; i++) {
                const userBar = document.createElement('div');
                userBar.className = 'voice-activity-bar';
                userBarsContainer.appendChild(userBar);
                userVoiceActivityBars.push(userBar);

                const assistantBar = document.createElement('div');
                assistantBar.className = 'voice-activity-bar assistant';
                assistantBarsContainer.appendChild(assistantBar);
                assistantVoiceActivityBars.push(assistantBar);
            }
        }

        // Update voice activity visualization with enhanced sensitivity
        function updateVoiceActivity(analyser, bars) {
            if (!analyser) return;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            // Calculate average levels for each bar with enhanced sensitivity
            const barWidth = Math.floor(dataArray.length / NUM_BARS);
            for (let i = 0; i < NUM_BARS; i++) {
                const start = i * barWidth;
                const end = start + barWidth;
                let sum = 0;
                let peak = 0;
                
                // Find both average and peak values for more dynamic visualization
                for (let j = start; j < end; j++) {
                    sum += dataArray[j];
                    peak = Math.max(peak, dataArray[j]);
                }
                
                const average = sum / barWidth;
                // Use a combination of average and peak for more dynamic movement
                const scaleFactor = (average * 0.7 + peak * 0.3) / 256;
                
                // Apply non-linear scaling for better visualization of quiet sounds
                const enhancedScale = Math.pow(scaleFactor, 0.7) * 1.5;
                
                // Add slight randomization for more natural movement
                const jitter = (Math.random() * 0.1 - 0.05);
                
                // Ensure minimum height and apply enhanced scaling
                const finalScale = Math.max(0.1, Math.min(1, enhancedScale + jitter));
                
                bars[i].style.transform = `scaleY(${finalScale})`;
            }
        }

        // Animation loop for voice activity
        function animateVoiceActivity() {
            updateVoiceActivity(userAnalyser, userVoiceActivityBars);
            updateVoiceActivity(assistantAnalyser, assistantVoiceActivityBars);
            requestAnimationFrame(animateVoiceActivity);
        }

        // Initialize Web Audio context and analysers with enhanced settings
        function initAudioAnalysis() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Create analysers with more detailed FFT size
            userAnalyser = audioContext.createAnalyser();
            userAnalyser.fftSize = 512;  // Increased for more detailed analysis
            userAnalyser.minDecibels = -90;  // Lower threshold for detecting quiet sounds
            userAnalyser.maxDecibels = -10;  // Upper threshold
            userAnalyser.smoothingTimeConstant = 0.6;  // Reduced for more responsive movement
            
            assistantAnalyser = audioContext.createAnalyser();
            assistantAnalyser.fftSize = 512;
            assistantAnalyser.minDecibels = -90;
            assistantAnalyser.maxDecibels = -10;
            assistantAnalyser.smoothingTimeConstant = 0.6;
            
            // Start animation
            animateVoiceActivity();
        }

        function addMessage(text, isUser = false) {
            const div = document.createElement('div');
            div.className = `transcription final ${isUser ? 'user' : 'assistant'}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const parsedContent = marked.parse(text, {
                gfm: true,
                breaks: true,
                tables: true
            });
            
            const sanitizedContent = DOMPurify.sanitize(parsedContent, {
                ALLOWED_TAGS: [
                    'p', 'br', 'strong', 'em', 'code', 'pre', 'table', 'thead', 'tbody',
                    'tr', 'th', 'td', 'ul', 'ol', 'li', 'blockquote', 'h1', 'h2', 'h3',
                    'h4', 'h5', 'h6', 'a', 'img', 'span'
                ],
                ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class']
            });
            
            contentDiv.innerHTML = sanitizedContent;
            div.appendChild(contentDiv);
            transcriptionBox.appendChild(div);
            transcriptionBox.scrollTop = transcriptionBox.scrollHeight;
        }

        function updateTranscriptionStatus(message) {
            transcriptionStatus.textContent = message;
        }

        function updateStatus(message) {
            status.textContent = 'Status: ' + message;
        }

        function addTranscription(text, isInterim = true) {
            if (!currentTranscriptionDiv || !isInterim) {
                currentTranscriptionDiv = document.createElement('div');
                currentTranscriptionDiv.className = `transcription ${isInterim ? 'interim' : 'final'}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                const parsedContent = marked.parse(text, {
                    gfm: true,
                    breaks: true,
                    tables: true
                });
                
                const sanitizedContent = DOMPurify.sanitize(parsedContent, {
                    ALLOWED_TAGS: [
                        'p', 'br', 'strong', 'em', 'code', 'pre', 'table', 'thead', 'tbody',
                        'tr', 'th', 'td', 'ul', 'ol', 'li', 'blockquote', 'h1', 'h2', 'h3',
                        'h4', 'h5', 'h6', 'a', 'img', 'span'
                    ],
                    ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class']
                });
                
                contentDiv.innerHTML = sanitizedContent;
                currentTranscriptionDiv.appendChild(contentDiv);
                transcriptionBox.appendChild(currentTranscriptionDiv);
            } else {
                const contentDiv = currentTranscriptionDiv.querySelector('.message-content');
                if (contentDiv) {
                    const parsedContent = marked.parse(text, {
                        gfm: true,
                        breaks: true,
                        tables: true
                    });
                    
                    const sanitizedContent = DOMPurify.sanitize(parsedContent, {
                        ALLOWED_TAGS: [
                            'p', 'br', 'strong', 'em', 'code', 'pre', 'table', 'thead', 'tbody',
                            'tr', 'th', 'td', 'ul', 'ol', 'li', 'blockquote', 'h1', 'h2', 'h3',
                            'h4', 'h5', 'h6', 'a', 'img', 'span'
                        ],
                        ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class']
                    });
                    
                    contentDiv.innerHTML = sanitizedContent;
                }
            }
            
            requestAnimationFrame(() => {
                transcriptionBox.scrollTop = transcriptionBox.scrollHeight;
            });
            
            if (!isInterim) {
                currentTranscriptionDiv = null;
            }
        }

        async function initWebRTC() {
            try {
                console.log('Initializing WebRTC with model:', RT_MODEL);
                updateStatus('Initializing connection...');
                
                // Initialize voice activity visualization
                initVoiceActivity();
                initAudioAnalysis();
                
                // Get ephemeral key from server
                const tokenResponse = await fetch(`${RT_ENDPOINT}?model=${RT_MODEL}&voice=${RT_VOICE}`);
                const data = await tokenResponse.json();
                const EPHEMERAL_KEY = data.client_secret.value;
                
                // Create a peer connection
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });

                // Set up audio element for remote audio
                audioEl = document.createElement('audio');
                audioEl.autoplay = true;
                audioEl.controls = true;
                document.body.appendChild(audioEl);

                // Handle incoming audio stream
                pc.ontrack = (event) => {
                    console.log('Received remote track:', event);
                    if (event.track.kind === 'audio') {
                        const stream = new MediaStream([event.track]);
                        audioEl.srcObject = stream;
                        audioEl.play().catch(e => console.error('Error playing audio:', e));
                        
                        // Connect assistant audio to analyser
                        const source = audioContext.createMediaStreamSource(stream);
                        source.connect(assistantAnalyser);
                        
                        updateStatus('Connected! Remote audio enabled.');
                    }
                };

                // Set up data channel first
                dc = pc.createDataChannel('oai-events', {
                    ordered: true
                });
                dc.addEventListener('message', handleMessage);
                dc.addEventListener('open', () => {
                    console.log('Data channel opened');
                    updateStatus('Connected! You can start speaking.');
                    updateInputState(true);  // Enable input when data channel opens
                    sendInitialPrompt();
                });

                dc.addEventListener('close', () => {
                    console.log('Data channel closed');
                    updateStatus('Data channel closed');
                    updateInputState(false);
                });

                dc.addEventListener('error', (error) => {
                    console.error('Data channel error:', error);
                    updateStatus('Data channel error: ' + error);
                });

                // Add a transceiver before getting user media
                const transceiver = pc.addTransceiver('audio', {
                    direction: 'sendrecv',
                    streams: []
                });

                // Add local audio track with specific constraints
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    
                    const audioTrack = stream.getAudioTracks()[0];
                    console.log('Adding local track:', audioTrack);
                    transceiver.sender.replaceTrack(audioTrack);
                    
                    // Connect user audio to analyser
                    const source = audioContext.createMediaStreamSource(stream);
                    source.connect(userAnalyser);
                    
                    updateStatus('Microphone connected successfully');
                } catch (err) {
                    console.error('Error accessing microphone:', err);
                    updateStatus('Error: Could not access microphone');
                    return;
                }

                // Create offer with specific constraints
                const offer = await pc.createOffer({
                    offerToReceiveAudio: true
                });

                // Clean up SDP
                const sdpLines = offer.sdp.split('\n');
                const cleanedSdpLines = sdpLines.map(line => {
                    // Remove any existing fmtp lines for opus
                    if (line.includes('a=fmtp:111')) {
                        return 'a=fmtp:111 minptime=10;useinbandfec=1;stereo=1;maxaveragebitrate=510000';
                    }
                    return line;
                });
                offer.sdp = cleanedSdpLines.join('\n');

                console.log('Modified SDP:', offer.sdp);
                
                await pc.setLocalDescription(offer);

                // Connect to OpenAI's Realtime API
                const baseUrl = 'https://api.openai.com/v1/realtime';
                console.log('Connecting to OpenAI with model:', RT_MODEL);
                const sdpResponse = await fetch(`${baseUrl}?model=${RT_MODEL}`, {
                    method: 'POST',
                    body: offer.sdp,
                    headers: {
                        'Authorization': `Bearer ${EPHEMERAL_KEY}`,
                        'Content-Type': 'application/sdp'
                    },
                });

                if (!sdpResponse.ok) {
                    const errorText = await sdpResponse.text();
                    console.error('OpenAI API Error:', errorText);
                    throw new Error('Failed to connect to OpenAI: ' + errorText);
                }

                const answer = {
                    type: 'answer',
                    sdp: await sdpResponse.text(),
                };
                await pc.setRemoteDescription(answer);

                // Add connection state monitoring
                pc.onconnectionstatechange = () => {
                    console.log('Connection state changed:', pc.connectionState);
                    updateStatus(`Connection state: ${pc.connectionState}`);
                    const isConnected = pc.connectionState === 'connected';
                    console.log('Updating input state:', isConnected);
                    updateInputState(isConnected);
                    updateConnectionStatus(isConnected);
                };

                pc.oniceconnectionstatechange = () => {
                    console.log('ICE connection state changed:', pc.iceConnectionState);
                    updateStatus(`ICE connection state: ${pc.iceConnectionState}`);
                };

                startButton.disabled = true;
                stopButton.disabled = false;

            } catch (error) {
                console.error('Error in initWebRTC:', error);
                updateStatus('Error: ' + error.message);
            }
        }

        function addEventToLog(event, isFromServer = true) {
            const eventLog = document.getElementById('event-log');
            const entry = document.createElement('div');
            entry.className = 'event-entry';
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour12: true,
                hour: "numeric",
                minute: "numeric",
                second: "numeric"
            });

            // Create the header part
            const header = document.createElement('div');
            header.className = 'event-header';
            header.innerHTML = `
                <span class="event-arrow ${isFromServer ? 'up' : 'down'}">
                    ${isFromServer ? 'â†‘' : 'â†“'}
                </span>
                <span class="event-type">${isFromServer ? 'server: ' : 'client: '}${event.type}</span>
                <span class="event-time">${timeStr}</span>
            `;

            // Create the JSON part with syntax highlighting
            const jsonPart = document.createElement('div');
            jsonPart.className = 'event-json';
            jsonPart.innerHTML = syntaxHighlight(event);

            entry.appendChild(header);
            entry.appendChild(jsonPart);
            
            // Add click handler to toggle JSON view only on header
            header.addEventListener('click', (e) => {
                entry.classList.toggle('expanded');
                e.stopPropagation(); // Prevent event from bubbling
            });
            
            eventLog.appendChild(entry);
            // Ensure scroll to bottom
            requestAnimationFrame(() => {
                eventLog.scrollTop = eventLog.scrollHeight;
            });
        }

        // Function to add syntax highlighting to JSON
        function syntaxHighlight(obj) {
            const json = JSON.stringify(obj, null, 2);
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        async function sendInitialPrompt() {
            if (dc && dc.readyState === 'open') {
                // First, send session config
                const configEvent = {
                    type: 'session.update',
                    session: {
                        modalities: ['text', 'audio'],
                        instructions: "You are Rexie, an AI assistant for ODI cricket data analysis. Your role is to:\n\n1. Use the cricket database query tool to answer questions about ODI matches from 2003-2024\n2. Only provide answers based on the database results\n3. Never make up data or use external sources\n4. Keep responses concise and factual\n\nThe database contains ball-by-ball data for 2860 ODI matches from Dec 2023 to Dec 2024 in backend database.",
                        turn_detection: {
                            type: 'server_vad',
                            threshold: 0.75,
                            prefix_padding_ms: 1000,
                            silence_duration_ms: 1000,
                            create_response: true
                        },
                        tools: [{
                            type: 'function',
                            name: 'cricket_query',
                            description: 'This is an LLM agent that has access to a cricket database. Use this tool for any questions related to cricket, cricket database, ODI, one day international, or any cricket-related queries. The agent is connected to a database and will handle the SQL operations internally.The agent can also generate charts and graphs based on the data.The agent can also push data to the users docs or google docs if the user asks to do so - just send a request saying "push data to my docs" or "push data to my google docs" and the agent will do it- no docuemnt id etc required',
                            parameters: {
                                type: 'object',
                                properties: {
                                    question: {
                                        type: 'string',
                                        description: 'The natural language query about cricket'
                                    }
                                },
                                required: ['question']
                            }
                        }]
                    }
                };
                dc.send(JSON.stringify(configEvent));
                addEventToLog(configEvent, false);

                // Wait a brief moment
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Then start the conversation
                const startEvent = {
                    type: 'response.create',
                    response: {
                        modalities: ['text', 'audio'],
                        instructions: 'You are a helpful AI assistant. Please respond to the user in a friendly and concise manner.. Start with this welcome message "Hello, How are you doing this wonderful day. This is Rexie, your ODI cricket data assistant designed by Amar Harolikar. How can i help you?"'
                    }
                };
                dc.send(JSON.stringify(startEvent));
                addEventToLog(startEvent, false);
            }
        }

        // Add chart storage and navigation
        let currentChartIndex = 0;
        const chartStorage = {
            items: [],
            add: function(imageUrl) {
                this.items.push(imageUrl);
                return this.items.length - 1;
            },
            get: function(index) {
                return this.items[index];
            },
            count: function() {
                return this.items.length;
            }
        };

        // Navigation function
        function navigateCharts(direction) {
            if (chartStorage.count() <= 1) return;
            
            currentChartIndex = (currentChartIndex + direction + chartStorage.count()) % chartStorage.count();
            
            const containers = document.querySelectorAll('.chart-image-container');
            containers.forEach((container, index) => {
                container.style.display = index === currentChartIndex ? 'block' : 'none';
            });
            
            const counter = document.querySelector('.chart-counter');
            counter.textContent = `${currentChartIndex + 1} / ${chartStorage.count()}`;
        }

        // Add chart function
        function addChart(imageUrl) {
            const chartContent = document.getElementById('chartContent');
            const emptyState = chartContent.querySelector('.chart-content-empty');
            if (emptyState) {
                emptyState.remove();
            }

            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-image-container';
            
            const chartImg = document.createElement('img');
            chartImg.className = 'chart-image';
            chartImg.alt = 'Generated Chart';
            chartImg.src = imageUrl;
            
            chartContainer.appendChild(chartImg);
            chartContent.appendChild(chartContainer);
            
            currentChartIndex = chartStorage.add(imageUrl);
            
            const prevBtn = document.querySelector('.chart-nav-prev');
            const nextBtn = document.querySelector('.chart-nav-next');
            const counter = document.querySelector('.chart-counter');
            
            if (chartStorage.count() > 1) {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
                counter.style.display = 'block';
            }
            
            counter.textContent = `${currentChartIndex + 1} / ${chartStorage.count()}`;
            
            const containers = document.querySelectorAll('.chart-image-container');
            containers.forEach((container, index) => {
                container.style.display = index === currentChartIndex ? 'block' : 'none';
            });
        }

        // Add navigation button event listeners
        document.querySelector('.chart-nav-prev').addEventListener('click', () => navigateCharts(-1));
        document.querySelector('.chart-nav-next').addEventListener('click', () => navigateCharts(1));

        // Modify handleMessage function to handle chart URLs
        async function handleMessage(e) {
            try {
                const event = JSON.parse(e.data);
                console.log('Received event:', event);

                // Add handling for conversation.item.created with function_call_output
                if (event.type === 'conversation.item.created' && 
                    event.item?.type === 'function_call_output') {
                    try {
                        console.log('Processing function_call_output:', event.item);
                        const outputObj = JSON.parse(event.item.output);
                        console.log('Parsed output object:', outputObj);
                        
                        if (outputObj.artifacts) {
                            console.log('Found artifacts:', outputObj.artifacts);
                            for (const artifact of outputObj.artifacts) {
                                console.log('Processing artifact:', artifact);
                                if (artifact.type === 'png' && artifact.data.startsWith('FILE-STORAGE::')) {
                                    const fileName = artifact.data.replace('FILE-STORAGE::', '');
                                    console.log('Extracted fileName:', fileName);
                                    console.log('Chat ID:', outputObj.chatId);
                                    
                                    // Fix the URL construction
                                    const baseUrl = 'https://flowise-coolify.hosting.tigzig.com';
                                    console.log('Base URL:', baseUrl);
                                    
                                    const imageUrl = `${baseUrl}/api/v1/get-upload-file?chatflowId=5e61fc5e-a2d9-410d-b1a4-1519fa0c3b4d&chatId=${outputObj.chatId}&fileName=${fileName}`;
                                    console.log('Final constructed image URL:', imageUrl);
                                    
                                    addChart(imageUrl);
                                }
                            }
                        } else {
                            console.log('No artifacts found in output object');
                        }
                    } catch (err) {
                        console.error('Error processing function_call_output:', err);
                        console.error('Raw output:', event.item.output);
                    }
                }

                // Add server event to log only if it's not an audio transcript delta event that should be hidden
                if (!(
                    (event.type === 'response.audio_transcript.delta' && !SHOW_AUDIO_TRANSCRIPT_DELTA) ||
                    (event.type.toLowerCase().includes('delta') && !SHOW_DELTA_EVENTS)
                )) {
                    addEventToLog(event, true);
                }

                // Get current timestamp for the transcription
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { 
                    hour12: true,
                    hour: "numeric",
                    minute: "numeric",
                    second: "numeric"
                });

                // Extract and display specific items based on event type
                switch (event.type) {
                    case 'response.done':
                        try {
                            // Extract transcript and role if available
                            const output = event.response?.output?.[0];
                            const transcript = output?.content?.[0]?.transcript;
                            const role = output?.role;
                            const usage = event.response?.usage;

                            if (transcript) {
                                let transcriptText = '';
                                // Add role if available, otherwise use "Transcript"
                                transcriptText += role ? `${role}: ` : 'Transcript: ';
                                transcriptText += transcript;
                                
                                // Add timestamp and usage if available
                                if (usage) {
                                    transcriptText += ` <span class="metadata">(${timeStr}, Tokens - Total: ${usage.total_tokens}, Input: ${usage.input_tokens}, Output: ${usage.output_tokens})</span>`;
                                } else {
                                    transcriptText += ` <span class="metadata">(${timeStr})</span>`;
                                }
                                addTranscription(transcriptText, false);
                            } else if (usage) {
                                addTranscription(`Tokens - Total: ${usage.total_tokens}, Input: ${usage.input_tokens}, Output: ${usage.output_tokens} <span class="metadata">(${timeStr})</span>`, false);
                            }

                            // Extract function call arguments if available
                            if (output?.type === 'function_call' && output.arguments) {
                                try {
                                    const args = JSON.parse(output.arguments);
                                    if (args.question) {
                                        addTranscription(`Query: ${args.question} <span class="metadata">(${timeStr})</span>`, false);
                                    }
                                } catch (err) {
                                    console.log('Error parsing function arguments:', err);
                                }
                            }
                        } catch (err) {
                            console.log('Error processing response.done event:', err);
                        }
                        break;

                    case 'conversation.item.created':
                        try {
                            if (event.item?.type === 'function_call_output') {
                                const outputObj = JSON.parse(event.item.output);
                                if (outputObj.text) {
                                    let outputText = outputObj.text;
                                    if (outputObj.tokens) {
                                        outputText += ` <span class="metadata">(${timeStr}, Tokens: ${outputObj.tokens})</span>`;
                                    } else {
                                        outputText += ` <span class="metadata">(${timeStr})</span>`;
                                    }
                                    addTranscription(outputText, false);

                                    // Add this new code to trigger a response after function output
                                    setTimeout(() => {
                                        const triggerResponseEvent = {
                                            type: 'response.create',
                                            response: {
                                                modalities: ['text', 'audio'],
                                                instructions: 'Present the results from the cricket database query that was just executed.'
                                            }
                                        };
                                        dc.send(JSON.stringify(triggerResponseEvent));
                                        addEventToLog(triggerResponseEvent, false);
                                    }, 500);
                                }
                            }
                        } catch (err) {
                            console.log('No text in function_call_output');
                        }
                        break;

                    case 'text.delta':
                        if (event.delta?.text) {
                            let deltaText = event.delta.text;
                            if (event.delta?.tokens) {
                                deltaText += ` <span class="metadata">(${timeStr}, Tokens: ${event.delta.tokens})</span>`;
                            } else {
                                deltaText += ` <span class="metadata">(${timeStr})</span>`;
                            }
                            addMessage(deltaText);
                        }
                        break;

                    case 'input_audio_transcription.interim':
                        let interimText = event.transcription;
                        if (event.tokens) {
                            interimText += ` <span class="metadata">(${timeStr}, Tokens: ${event.tokens})</span>`;
                        } else {
                            interimText += ` <span class="metadata">(${timeStr})</span>`;
                        }
                        addTranscription(interimText, true);
                        updateTranscriptionStatus('Transcribing...');
                        break;

                    case 'input_audio_transcription.final':
                        let finalText = event.transcription;
                        if (event.tokens) {
                            finalText += ` <span class="metadata">(${timeStr}, Tokens: ${event.tokens})</span>`;
                        } else {
                            finalText += ` <span class="metadata">(${timeStr})</span>`;
                        }
                        addTranscription(finalText, false);
                        updateTranscriptionStatus('Done');
                        break;

                    case 'response.audio_transcript.delta':
                        if (event.delta?.text) {
                            let audioText = `Assistant: ${event.delta.text}`;
                            if (event.delta?.tokens) {
                                audioText += ` <span class="metadata">(${timeStr}, Tokens: ${event.delta.tokens})</span>`;
                            } else {
                                audioText += ` <span class="metadata">(${timeStr})</span>`;
                            }
                            addTranscription(audioText, false);
                        }
                        break;

                    case 'input_audio_buffer.speech_started':
                        updateStatus('Listening...');
                        updateTranscriptionStatus('Listening...');
                        break;

                    case 'input_audio_buffer.speech_stopped':
                        updateStatus('Processing...');
                        updateTranscriptionStatus('Processing...');
                        break;

                    case 'response.function_call_arguments.done':
                        if (event.name === 'cricket_query') {
                            const args = JSON.parse(event.arguments);
                            const result = await queryCricketDatabase({ question: args.question });
                            const responseEvent = {
                                type: 'conversation.item.create',
                                item: {
                                    type: 'function_call_output',
                                    call_id: event.call_id,
                                    output: JSON.stringify(result)
                                }
                            };
                            dc.send(JSON.stringify(responseEvent));
                            addEventToLog(responseEvent, false);
                        }
                        break;
                }
            } catch (error) {
                console.error('Error handling message:', error);
                // Don't throw error, just log it
            }
        }

        function stopConnection() {
            if (pc) {
                // Properly close all tracks
                const senders = pc.getSenders();
                senders.forEach(sender => {
                    if (sender.track) {
                        sender.track.stop();
                    }
                });
                pc.close();
            }
            if (audioEl) {
                if (audioEl.srcObject) {
                    audioEl.srcObject.getTracks().forEach(track => track.stop());
                }
                audioEl.srcObject = null;
                audioEl.remove();
            }
            startButton.disabled = false;
            stopButton.disabled = true;
            updateInputState(false);
            updateStatus('Disconnected');
            updateConnectionStatus(false);
        }

        function sendTextMessage(text) {
            if (dc && dc.readyState === 'open') {
                const messageEvent = {
                    type: 'conversation.item.create',
                    item: {
                        type: 'message',
                        role: 'user',
                        content: [{
                            type: 'input_text',
                            text: text
                        }]
                    }
                };
                dc.send(JSON.stringify(messageEvent));
                addEventToLog(messageEvent, false);
                addMessage(text, true);

                // Request a response from the assistant
                const responseEvent = {
                    type: 'response.create',
                    response: {
                        modalities: ['text', 'audio']
                    }
                };
                dc.send(JSON.stringify(responseEvent));
                addEventToLog(responseEvent, false);
            }
        }

        // Enable/disable text input based on connection state
        function updateInputState(enabled) {
            textInput.disabled = !enabled;
            sendButton.disabled = !enabled;
        }

        // Handle send button click
        sendButton.addEventListener('click', () => {
            const text = textInput.value.trim();
            if (text) {
                sendTextMessage(text);
                textInput.value = '';
            }
        });

        // Handle enter key in text input
        textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const text = textInput.value.trim();
                if (text) {
                    sendTextMessage(text);
                    textInput.value = '';
                }
            }
        });

        startButton.addEventListener('click', initWebRTC);
        stopButton.addEventListener('click', stopConnection);

        // VAD Settings Controls
        const threshold = document.getElementById('threshold');
        const prefixPadding = document.getElementById('prefixPadding');
        const silenceDuration = document.getElementById('silenceDuration');
        const submitVadSettings = document.getElementById('submitVadSettings');
        const settingsModal = document.getElementById('settingsModal');
        const settingsOverlay = document.getElementById('settingsOverlay');
        const openSettings = document.getElementById('openSettings');
        const closeSettings = document.getElementById('closeSettings');

        // Display values
        const thresholdValue = document.getElementById('thresholdValue');
        const prefixPaddingValue = document.getElementById('prefixPaddingValue');
        const silenceDurationValue = document.getElementById('silenceDurationValue');

        // Initial values
        let initialSettings = {
            threshold: 0.75,
            prefixPadding: 1000,
            silenceDuration: 1000
        };

        // Modal controls
        function openModal() {
            settingsModal.classList.add('active');
            settingsOverlay.classList.add('active');
        }

        function closeModal() {
            settingsModal.classList.remove('active');
            settingsOverlay.classList.remove('active');
            // Reset values to current settings
            threshold.value = initialSettings.threshold;
            prefixPadding.value = initialSettings.prefixPadding;
            silenceDuration.value = initialSettings.silenceDuration;
            updateValue(threshold, thresholdValue);
            updateValue(prefixPadding, prefixPaddingValue);
            updateValue(silenceDuration, silenceDurationValue);
            submitVadSettings.disabled = true;
        }

        openSettings.addEventListener('click', openModal);
        closeSettings.addEventListener('click', closeModal);
        settingsOverlay.addEventListener('click', closeModal);

        // Update display values and check for changes
        function updateValue(slider, display) {
            display.textContent = slider.value;
            checkForChanges();
        }

        threshold.addEventListener('input', () => updateValue(threshold, thresholdValue));
        prefixPadding.addEventListener('input', () => updateValue(prefixPadding, prefixPaddingValue));
        silenceDuration.addEventListener('input', () => updateValue(silenceDuration, silenceDurationValue));

        // Check if any values have changed from initial settings
        function checkForChanges() {
            const hasChanges = 
                parseFloat(threshold.value) !== initialSettings.threshold ||
                parseInt(prefixPadding.value) !== initialSettings.prefixPadding ||
                parseInt(silenceDuration.value) !== initialSettings.silenceDuration;
            
            submitVadSettings.disabled = !hasChanges;
        }

        // Handle settings submission
        submitVadSettings.addEventListener('click', () => {
            if (dc && dc.readyState === 'open') {
                const updateEvent = {
                    type: 'session.update',
                    session: {
                        modalities: ['text', 'audio'],
                        turn_detection: {
                            type: 'server_vad',
                            threshold: parseFloat(threshold.value),
                            prefix_padding_ms: parseInt(prefixPadding.value),
                            silence_duration_ms: parseInt(silenceDuration.value),
                            create_response: true
                        }
                    }
                };

                // Send the update event
                dc.send(JSON.stringify(updateEvent));
                addEventToLog(updateEvent, false);

                // Update initial settings to new values
                initialSettings = {
                    threshold: parseFloat(threshold.value),
                    prefixPadding: parseInt(prefixPadding.value),
                    silenceDuration: parseInt(silenceDuration.value)
                };

                // Disable submit button and close modal
                submitVadSettings.disabled = true;
                closeModal();
            }
        });

        // Prevent clicks inside modal from closing it
        settingsModal.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Update connection indicator
        function updateConnectionStatus(isConnected) {
            const orb = document.querySelector('.connection-orb');
            const statusText = document.querySelector('.connection-status');
            const statusIcon = document.querySelector('.connection-status-icon');
            
            if (isConnected) {
                orb.classList.add('active');
                statusText.textContent = 'Connected';
                statusIcon.title = 'Strong Signal';
                statusIcon.innerHTML = '<img src="antenna-bars-svgrepo-com.svg" alt="Strong Signal" />';
                statusIcon.className = 'connection-status-icon connected';
            } else {
                orb.classList.remove('active');
                statusText.textContent = 'Disconnected';
                statusIcon.title = 'No Signal';
                statusIcon.innerHTML = '<img src="no-mobile-phones-svgrepo-com.svg" alt="No Signal" />';
                statusIcon.className = 'connection-status-icon disconnected';
            }
        }

        // Add tab switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Add document section functionality
            const DOCUMENT_URLS = {
                excel: {
                    view: 'https://harolikar-my.sharepoint.com/personal/amar_harolikar_com/_layouts/15/Doc.aspx?sourcedoc={371a2aba-3da4-4966-8d5a-e02eb2038845}&action=embedview&wdAllowInteractivity=False&wdHideGridlines=True&wdHideHeaders=True&wdDownloadButton=True&wdInConfigurator=True&wdInConfigurator=True',
                    edit: 'https://harolikar-my.sharepoint.com/personal/amar_harolikar_com/_layouts/15/Doc.aspx?sourcedoc={371a2aba-3da4-4966-8d5a-e02eb2038845}&action=edit'
                },
                google: {
                    view: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT-ASVIfFJ4HdqIjq-2fSar4taGxlUutrZCeH1dFgfT6o-baBFQHLtJcGwgretrT2NmqtbQe7FbmxiS/pubhtml?widget=true&headers=false',
                    edit: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT-ASVIfFJ4HdqIjq-2fSar4taGxlUutrZCeH1dFgfT6o-baBFQHLtJcGwgretrT2NmqtbQe7FbmxiS/pubhtml?widget=true&headers=false'
                },
                docs: {
                    view: 'https://docs.google.com/document/d/e/2PACX-1vQ2z_n6-egJOrvFLMXsIBWvhxoPg01fS2XMchIJ-993uqD9YbaNbw9H1ZTD09CzeZ-VetsRNML2p3qF/pub?embedded=true',
                    edit: 'https://docs.google.com/document/d/1v8BQURR8F6yoVlxGMmjPE9hEJAsLyx7cjtjiNLiXkhk/edit?usp=sharing'
                }
            };

            const documentFrame = document.getElementById('documentFrame');
            const typeButtons = document.querySelectorAll('.doc-type-button');
            const collapseButton = document.querySelector('.collapse-button');
            const refreshButton = document.querySelector('.refresh-button');
            const maximizeButton = document.querySelector('.maximize-button');
            const documentContent = document.querySelector('.document-content');
            const loadingOverlay = document.querySelector('.loading-overlay');

            let activeType = 'docs';  // Changed default to 'docs'

            // Initialize iframe source and active button
            documentFrame.src = DOCUMENT_URLS[activeType].view;
            typeButtons.forEach(button => {
                if (button.dataset.type === activeType) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            // Handle document type switching
            typeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const type = button.dataset.type;
                    activeType = type;
                    
                    // Update active button
                    typeButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    // Update iframe source
                    documentFrame.src = DOCUMENT_URLS[type].view;
                });
            });

            // Handle collapse/expand
            collapseButton.addEventListener('click', () => {
                documentContent.classList.toggle('collapsed');
                // Update icon
                const svg = collapseButton.querySelector('svg');
                if (documentContent.classList.contains('collapsed')) {
                    svg.innerHTML = '<polyline points="6 9 12 15 18 9"></polyline>';
                } else {
                    svg.innerHTML = '<polyline points="18 15 12 9 6 15"></polyline>';
                }
            });

            // Handle refresh
            refreshButton.addEventListener('click', () => {
                loadingOverlay.classList.remove('hidden');
                documentFrame.src = documentFrame.src;
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                }, 1000);
            });

            // Handle maximize - use the active type's edit URL
            maximizeButton.addEventListener('click', () => {
                window.open(DOCUMENT_URLS[activeType].edit, '_blank');
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Text chat functionality
            const textChatInput = document.getElementById('textChatInput');
            const textChatSendButton = document.getElementById('textChatSendButton');
            const textChatMessages = document.getElementById('text-chat-messages');
            let isTextChatLoading = false;

            // Auto-resize textarea
            textChatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Add message to chat
            function addTextChatMessage(content, role) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                
                // Create a container for the message content
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                // Parse markdown and sanitize the HTML
                const parsedContent = marked.parse(content, {
                    gfm: true,        // GitHub Flavored Markdown
                    breaks: true,     // Convert \n to <br>
                    tables: true      // Enable tables
                });
                
                // Sanitize the HTML to prevent XSS
                const sanitizedContent = DOMPurify.sanitize(parsedContent, {
                    ALLOWED_TAGS: [
                        'p', 'br', 'strong', 'em', 'code', 'pre', 'table', 'thead', 'tbody',
                        'tr', 'th', 'td', 'ul', 'ol', 'li', 'blockquote', 'h1', 'h2', 'h3',
                        'h4', 'h5', 'h6', 'a', 'img'
                    ],
                    ALLOWED_ATTR: ['href', 'src', 'alt', 'title']
                });
                
                contentDiv.innerHTML = sanitizedContent;
                messageDiv.appendChild(contentDiv);
                textChatMessages.appendChild(messageDiv);
                textChatMessages.scrollTop = textChatMessages.scrollHeight;
            }

            // Handle message sending
            async function sendTextChatMessage() {
                if (isTextChatLoading || !textChatInput.value.trim()) return;

                // Add user message
                addTextChatMessage(textChatInput.value, 'user');
                const userMessage = textChatInput.value;
                textChatInput.value = '';
                textChatInput.style.height = '40px';

                // Show loading state
                isTextChatLoading = true;
                textChatSendButton.disabled = true;

                try {
                    const response = await fetch(CRICKET_API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            question: userMessage,
                            overrideConfig: {
                                sessionId: sessionId
                            }
                        })
                    });

                    if (!response.ok) throw new Error('API call failed');

                    const data = await response.json();
                    console.log('Text Chat API Response:', data);  // Debug log
                    
                    // Add assistant response
                    addTextChatMessage(data.text || data.message, 'assistant');

                    // Handle charts if present in response
                    if (data.artifacts && data.artifacts.length > 0) {
                        console.log('Text Chat - Found artifacts:', data.artifacts);  // Debug log
                        const imageArtifact = data.artifacts.find(artifact => 
                            artifact.type === 'png' || artifact.type === 'gif'
                        );
                        
                        if (imageArtifact && typeof imageArtifact.data === 'string') {
                            console.log('Text Chat - Found image artifact:', imageArtifact);  // Debug log
                            if (imageArtifact.data.startsWith('FILE-STORAGE::')) {
                                const fileName = imageArtifact.data.replace('FILE-STORAGE::', '');
                                console.log('Text Chat - Extracted fileName:', fileName);  // Debug log
                                console.log('Text Chat - Chat ID:', data.chatId);  // Debug log
                                
                                // Fix the URL construction
                                const baseUrl = CRICKET_API_ENDPOINT.split('/api/')[0];
                                console.log('Text Chat - Base URL:', baseUrl);  // Debug log
                                
                                const imageUrl = `${baseUrl}/api/v1/get-upload-file?chatflowId=5e61fc5e-a2d9-410d-b1a4-1519fa0c3b4d&chatId=${data.chatId}&fileName=${fileName}`;
                                console.log('Text Chat - Final image URL:', imageUrl);  // Debug log
                                
                                addChart(imageUrl);
                            }
                        }
                    }

                } catch (error) {
                    console.error('Error:', error);
                    addTextChatMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                } finally {
                    isTextChatLoading = false;
                    textChatSendButton.disabled = false;
                }
            }

            // Event listeners for text chat
            textChatSendButton.addEventListener('click', sendTextChatMessage);
            textChatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendTextChatMessage();
                }
            });

            // Add tab switching functionality for text chat
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Add chart expand/collapse functionality
            const chartContainer = document.querySelector('.chart-container');
            const expandButton = document.querySelector('.chart-expand-button');
            
            expandButton.addEventListener('click', () => {
                chartContainer.classList.toggle('expanded');
                // Update the icon based on state
                const svg = expandButton.querySelector('svg');
                if (chartContainer.classList.contains('expanded')) {
                    svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3H3v6M21 3h-6v6M3 21h6v-6M21 21h-6v-6"/>';
                } else {
                    svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>';
                }
            });

            // Close expanded chart when clicking outside
            document.addEventListener('click', (e) => {
                if (chartContainer.classList.contains('expanded') && 
                    !chartContainer.contains(e.target)) {
                    chartContainer.classList.remove('expanded');
                    const svg = expandButton.querySelector('svg');
                    svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>';
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Add tab container expand/collapse functionality
            const tabContainer = document.querySelector('.tab-container');
            const tabExpandButton = document.querySelector('.tab-expand-button');
            
            tabExpandButton.addEventListener('click', () => {
                tabContainer.classList.toggle('expanded');
                // Update the icon based on state
                const svg = tabExpandButton.querySelector('svg');
                if (tabContainer.classList.contains('expanded')) {
                    svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3H3v6M21 3h-6v6M3 21h6v-6M21 21h-6v-6"/>';
                } else {
                    svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>';
                }
            });

            // Close expanded tab container when clicking outside
            document.addEventListener('click', (e) => {
                if (tabContainer.classList.contains('expanded') && 
                    !tabContainer.contains(e.target)) {
                    tabContainer.classList.remove('expanded');
                    const svg = tabExpandButton.querySelector('svg');
                    svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>';
                }
            });
        });

        // Add this inside your DOMContentLoaded event listener
        function initializeResponsiveLayout() {
            const tabsContainer = document.querySelector('.mobile-tabs');
            const tabButtons = document.querySelectorAll('.mobile-tabs .tab-button');
            const contentContainers = {
                chat: document.querySelector('.tab-container'),
                charts: document.querySelector('.chart-container'),
                docs: document.querySelector('.document-section')
            };
            const contentContainer = document.querySelector('.content-container');

            function isMobileDevice() {
                return (
                    // Screen size checks
                    (window.innerWidth <= 768 || window.screen.width <= 768) ||
                    
                    // User Agent checks
                    /Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                    
                    // Platform check
                    /iPhone|iPod|Android/.test(navigator.platform) ||
                    
                    // Screen orientation capability
                    ('orientation' in window)
                );
            }

            function updateLayout() {
                const isMobile = isMobileDevice();
                
                // Show/hide mobile tabs
                tabsContainer.style.display = isMobile ? 'flex' : 'none';
                
                if (isMobile) {
                    // On mobile, show only the active section
                    const activeTab = document.querySelector('.mobile-tabs .tab-button.active');
                    const activeSection = activeTab ? activeTab.dataset.tab : 'chat';
                    
                    // Show content container for active section
                    contentContainer.style.display = 'flex';
                    contentContainer.classList.add('active');
                    
                    // Show/hide individual sections
                    Object.entries(contentContainers).forEach(([key, container]) => {
                        if (container) {
                            if (key === activeSection) {
                                container.style.display = 'flex';
                                container.classList.add('active');
                            } else {
                                container.style.display = 'none';
                                container.classList.remove('active');
                            }
                        }
                    });
                } else {
                    // On desktop, show all sections
                    contentContainer.style.display = 'flex';
                    contentContainer.classList.remove('active');
                    
                    Object.values(contentContainers).forEach(container => {
                        if (container) {
                            container.style.display = 'flex';
                            container.classList.remove('active');
                        }
                    });
                }
            }

            // Handle tab clicks
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Update active tab
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    if (window.innerWidth <= 768) {
                        // Show selected section
                        const selectedTab = button.dataset.tab;
                        Object.entries(contentContainers).forEach(([key, container]) => {
                            if (container) {
                                if (key === selectedTab) {
                                    container.style.display = 'flex';
                                    container.classList.add('active');
                                } else {
                                    container.style.display = 'none';
                                    container.classList.remove('active');
                                }
                            }
                        });
                    }
                });
            });

            // Listen for window resize
            window.addEventListener('resize', updateLayout);
            
            // Initial layout
            updateLayout();
        }

        // Make sure this is called when the document is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeResponsiveLayout();
        });

        // Sample data array
        const sampleData = [
            {
                match_id: "1426620",
                season: "2024/25",
                start_date: "2024-12-05",
                venue: "Allan Border Field, Brisbane",
                innings: "1",
                ball: "20.1",
                batting_team: "India",
                bowling_team: "Australia",
                striker: "JI Rodrigues",
                non_striker: "RM Ghosh",
                bowler: "A Sutherland",
                runs_off_bat: "0",
                extras: "0",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1426620",
                season: "2024/25",
                start_date: "2024-12-05",
                venue: "Allan Border Field, Brisbane",
                innings: "1",
                ball: "22.2",
                batting_team: "India",
                bowling_team: "Australia",
                striker: "JI Rodrigues",
                non_striker: "RM Ghosh",
                bowler: "A Sutherland",
                runs_off_bat: "4",
                extras: "0",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1426620",
                season: "2024/25",
                start_date: "2024-12-05",
                venue: "Allan Border Field, Brisbane",
                innings: "1",
                ball: "23.6",
                batting_team: "India",
                bowling_team: "Australia",
                striker: "JI Rodrigues",
                non_striker: "RM Ghosh",
                bowler: "A King",
                runs_off_bat: "2",
                extras: "0",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1426620",
                season: "2024/25",
                start_date: "2024-12-05",
                venue: "Allan Border Field, Brisbane",
                innings: "1",
                ball: "26.1",
                batting_team: "India",
                bowling_team: "Australia",
                striker: "JI Rodrigues",
                non_striker: "RM Ghosh",
                bowler: "KJ Garth",
                runs_off_bat: "0",
                extras: "0",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "bowled",
                player_dismissed: "JI Rodrigues",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1426620",
                season: "2024/25",
                start_date: "2024-12-05",
                venue: "Allan Border Field, Brisbane",
                innings: "1",
                ball: "27.2",
                batting_team: "India",
                bowling_team: "Australia",
                striker: "RM Ghosh",
                non_striker: "DB Sharma",
                bowler: "A Gardner",
                runs_off_bat: "1",
                extras: "0",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "run out",
                player_dismissed: "DB Sharma",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1426620",
                season: "2024/25",
                start_date: "2024-12-05",
                venue: "Allan Border Field, Brisbane",
                innings: "1",
                ball: "30.5",
                batting_team: "India",
                bowling_team: "Australia",
                striker: "RM Ghosh",
                non_striker: "SZ Thakor",
                bowler: "ML Schutt",
                runs_off_bat: "0",
                extras: "0",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "caught",
                player_dismissed: "RM Ghosh",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1426620",
                season: "2024/25",
                start_date: "2024-12-05",
                venue: "Allan Border Field, Brisbane",
                innings: "2",
                ball: "8.3",
                batting_team: "Australia",
                bowling_team: "India",
                striker: "G Voll",
                non_striker: "BL Mooney",
                bowler: "Renuka Singh",
                runs_off_bat: "0",
                extras: "1",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "1",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1426620",
                season: "2024/25",
                start_date: "2024-12-05",
                venue: "Allan Border Field, Brisbane",
                innings: "2",
                ball: "12.3",
                batting_team: "Australia",
                bowling_team: "India",
                striker: "A Sutherland",
                non_striker: "G Voll",
                bowler: "TR Sadhu",
                runs_off_bat: "1",
                extras: "0",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1426620",
                season: "2024/25",
                start_date: "2024-12-05",
                venue: "Allan Border Field, Brisbane",
                innings: "2",
                ball: "12.4",
                batting_team: "Australia",
                bowling_team: "India",
                striker: "G Voll",
                non_striker: "A Sutherland",
                bowler: "TR Sadhu",
                runs_off_bat: "4",
                extras: "0",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1426620",
                season: "2024/25",
                start_date: "2024-12-05",
                venue: "Allan Border Field, Brisbane",
                innings: "2",
                ball: "15.1",
                batting_team: "Australia",
                bowling_team: "India",
                striker: "A Gardner",
                non_striker: "G Voll",
                bowler: "Priya Mishra",
                runs_off_bat: "6",
                extras: "0",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1426620",
                season: "2024/25",
                start_date: "2024-12-05",
                venue: "Allan Border Field, Brisbane",
                innings: "2",
                ball: "15.2",
                batting_team: "Australia",
                bowling_team: "India",
                striker: "A Gardner",
                non_striker: "G Voll",
                bowler: "Priya Mishra",
                runs_off_bat: "1",
                extras: "0",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1432228",
                season: "2024/25",
                start_date: "2024-12-04",
                venue: "Diamond Oval, Kimberley",
                innings: "1",
                ball: "16.5",
                batting_team: "England",
                bowling_team: "South Africa",
                striker: "A Capsey",
                non_striker: "HC Knight",
                bowler: "A Dercksen",
                runs_off_bat: "0",
                extras: "1",
                wides: "1",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1432228",
                season: "2024/25",
                start_date: "2024-12-04",
                venue: "Diamond Oval, Kimberley",
                innings: "1",
                ball: "25.5",
                batting_team: "England",
                bowling_team: "South Africa",
                striker: "CE Dean",
                non_striker: "S Ecclestone",
                bowler: "N Mlaba",
                runs_off_bat: "0",
                extras: "5",
                wides: "5",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1432228",
                season: "2024/25",
                start_date: "2024-12-04",
                venue: "Diamond Oval, Kimberley",
                innings: "1",
                ball: "25.6",
                batting_team: "England",
                bowling_team: "South Africa",
                striker: "CE Dean",
                non_striker: "S Ecclestone",
                bowler: "N Mlaba",
                runs_off_bat: "0",
                extras: "2",
                wides: "2",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1432228",
                season: "2024/25",
                start_date: "2024-12-04",
                venue: "Diamond Oval, Kimberley",
                innings: "1",
                ball: "35.6",
                batting_team: "England",
                bowling_team: "South Africa",
                striker: "L Filer",
                non_striker: "CE Dean",
                bowler: "A Dercksen",
                runs_off_bat: "0",
                extras: "1",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "1",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1426551",
                season: "2024/25",
                start_date: "2024-11-10",
                venue: "Perth Stadium",
                innings: "1",
                ball: "22.6",
                batting_team: "Australia",
                bowling_team: "Pakistan",
                striker: "A Zampa",
                non_striker: "SA Abbott",
                bowler: "Mohammad Hasnain",
                runs_off_bat: "0",
                extras: "1",
                wides: "1",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1426551",
                season: "2024/25",
                start_date: "2024-11-10",
                venue: "Perth Stadium",
                innings: "2",
                ball: "17.1",
                batting_team: "Pakistan",
                bowling_team: "Australia",
                striker: "Abdullah Shafique",
                non_striker: "Saim Ayub",
                bowler: "LR Morris",
                runs_off_bat: "0",
                extras: "0",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "caught and bowled",
                player_dismissed: "Abdullah Shafique",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1426551",
                season: "2024/25",
                start_date: "2024-11-10",
                venue: "Perth Stadium",
                innings: "2",
                ball: "19.3",
                batting_team: "Pakistan",
                bowling_team: "Australia",
                striker: "Mohammad Rizwan",
                non_striker: "Babar Azam",
                bowler: "LR Morris",
                runs_off_bat: "0",
                extras: "1",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "1",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1432228",
                season: "2024/25",
                start_date: "2024-12-04",
                venue: "Diamond Oval, Kimberley",
                innings: "2",
                ball: "17.1",
                batting_team: "South Africa",
                bowling_team: "England",
                striker: "L Wolvaardt",
                non_striker: "A Dercksen",
                bowler: "S Ecclestone",
                runs_off_bat: "0",
                extras: "5",
                wides: "5",
                noballs: "0",
                byes: "0",
                legbyes: "0",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1432228",
                season: "2024/25",
                start_date: "2024-12-04",
                venue: "Diamond Oval, Kimberley",
                innings: "1",
                ball: "32.2",
                batting_team: "England",
                bowling_team: "South Africa",
                striker: "S Ecclestone",
                non_striker: "CE Dean",
                bowler: "N de Klerk",
                runs_off_bat: "0",
                extras: "1",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "1",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1426620",
                season: "2024/25",
                start_date: "2024-12-05",
                venue: "Allan Border Field, Brisbane",
                innings: "1",
                ball: "17.1",
                batting_team: "India",
                bowling_team: "Australia",
                striker: "JI Rodrigues",
                non_striker: "H Kaur",
                bowler: "A Gardner",
                runs_off_bat: "0",
                extras: "1",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "1",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            },
            {
                match_id: "1426620",
                season: "2024/25",
                start_date: "2024-12-05",
                venue: "Allan Border Field, Brisbane",
                innings: "1",
                ball: "3.4",
                batting_team: "India",
                bowling_team: "Australia",
                striker: "H Deol",
                non_striker: "PS Punia",
                bowler: "KJ Garth",
                runs_off_bat: "0",
                extras: "1",
                wides: "0",
                noballs: "0",
                byes: "0",
                legbyes: "1",
                penalty: "0",
                wicket_type: "",
                player_dismissed: "",
                other_wicket_type: "",
                other_player_dismissed: ""
            }

        ];

        // Function to render the sample data table
        function renderSampleDataTable() {
            const tbody = document.getElementById('sampleDataBody');
            sampleData.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.match_id}</td>
                    <td>${record.season}</td>
                    <td>${record.start_date}</td>
                    <td>${record.venue}</td>
                    <td>${record.innings}</td>
                    <td>${record.ball}</td>
                    <td>${record.batting_team}</td>
                    <td>${record.bowling_team}</td>
                    <td>${record.striker}</td>
                    <td>${record.non_striker}</td>
                    <td>${record.bowler}</td>
                    <td>${record.runs_off_bat}</td>
                    <td>${record.extras}</td>
                    <td>${record.wides}</td>
                    <td>${record.noballs}</td>
                    <td>${record.byes}</td>
                    <td>${record.legbyes}</td>
                    <td>${record.penalty}</td>
                    <td>${record.wicket_type}</td>
                    <td>${record.player_dismissed}</td>
                    <td>${record.other_wicket_type}</td>
                    <td>${record.other_player_dismissed}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Initialize the sample data table when the document is loaded
        document.addEventListener('DOMContentLoaded', function() {
            renderSampleDataTable();
        });

        // Add copy button functionality
        document.addEventListener('DOMContentLoaded', function() {
            const copyButton = document.querySelector('.chart-copy-button');
            
            copyButton.addEventListener('click', async () => {
                if (chartStorage.count() > 0) {
                    try {
                        // Get the current image element
                        const containers = document.querySelectorAll('.chart-image-container');
                        const currentImage = containers[currentChartIndex].querySelector('img');
                        
                        // Fetch the image data
                        const response = await fetch(currentImage.src);
                        const blob = await response.blob();
                        
                        try {
                            // Try modern clipboard API first
                            const clipboardItem = new ClipboardItem({
                                [blob.type]: blob
                            });
                            await navigator.clipboard.write([clipboardItem]);
                        } catch (clipboardErr) {
                            // If modern API fails, try creating a temporary image
                            const tempImage = new Image();
                            tempImage.src = currentImage.src;
                            
                            // Create a canvas once the image is loaded
                            tempImage.onload = function() {
                                const canvas = document.createElement('canvas');
                                canvas.width = tempImage.width;
                                canvas.height = tempImage.height;
                                
                                // Draw the image to canvas
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(tempImage, 0, 0);
                                
                                // Try to copy from canvas
                                canvas.toBlob(async (blob) => {
                                    try {
                                        await navigator.clipboard.write([
                                            new ClipboardItem({
                                                'image/png': blob
                                            })
                                        ]);
                                    } catch (finalErr) {
                                        console.error('All clipboard methods failed:', finalErr);
                                        // Only show download prompt as absolute last resort
                                        const link = document.createElement('a');
                                        link.href = currentImage.src;
                                        link.download = 'chart.png';
                                        document.body.appendChild(link);
                                        link.click();
                                        document.body.removeChild(link);
                                    }
                                }, 'image/png');
                            };
                        }
                        
                        // Show success feedback
                        copyButton.classList.add('copied');
                        copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>`;
                        
                        setTimeout(() => {
                            copyButton.classList.remove('copied');
                            copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
                            </svg>`;
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy image:', err);
                    }
                }
            });
        });

        // Add this function to update button styles based on device type
        function updateButtonStyles() {
            const buttonTexts = document.querySelectorAll('.button-text');
            const controlButtons = document.querySelectorAll('.control-button');
            
            if (isMobileDevice()) {
                buttonTexts.forEach(text => text.classList.add('hidden'));
                controlButtons.forEach(button => button.style.padding = '8px');
            } else {
                buttonTexts.forEach(text => text.classList.remove('hidden'));
                controlButtons.forEach(button => button.style.padding = '8px 16px');
            }
        }

        // Call on page load and window resize
        document.addEventListener('DOMContentLoaded', updateButtonStyles);
        window.addEventListener('resize', updateButtonStyles);
    </script>
    <footer class="footer">
        <div class="name-designation">Amar Harolikar, Specialist - Decision Sciences & Applied Generative AI</div>
        <div class="links">
            <a href="https://www.linkedin.com/in/amarharolikar" target="_blank" rel="noopener noreferrer">LinkedIn</a> | 
            <a href="https://rex.tigzig.com" target="_blank" rel="noopener noreferrer">rex.tigzig.com</a> | 
            <a href="https://tigzig.com" target="_blank" rel="noopener noreferrer">tigzig.com</a>
        </div>
    </footer>

    <!-- Sample Data Section -->
    <div class="sample-data-section">
        <h2>Sample Data Records</h2>
        <div class="table-container">
            <table class="sample-data-table">
                <thead>
                    <tr>
                        <th>Match ID</th>
                        <th>Season</th>
                        <th>Start Date</th>
                        <th>Venue</th>
                        <th>Innings</th>
                        <th>Ball</th>
                        <th>Batting Team</th>
                        <th>Bowling Team</th>
                        <th>Striker</th>
                        <th>Non Striker</th>
                        <th>Bowler</th>
                        <th>Runs Off Bat</th>
                        <th>Extras</th>
                        <th>Wides</th>
                        <th>No Balls</th>
                        <th>Byes</th>
                        <th>Leg Byes</th>
                        <th>Penalty</th>
                        <th>Wicket Type</th>
                        <th>Player Dismissed</th>
                        <th>Other Wicket Type</th>
                        <th>Other Player Dismissed</th>
                    </tr>
                </thead>
                <tbody id="sampleDataBody"></tbody>
            </table>
        </div>
    </div>
</body>
</html>

